<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Scheduler</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        screens: {
                            xs: "475px",
                        },
                    },
                },
            };
        </script>
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <style>
            /* Disable text selection on touch devices for better UX */
            @media (max-width: 640px) {
                .work-block,
                .work-block-mobile {
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                    -webkit-touch-callout: none;
                }
            }

            .time-slot {
                height: 60px;
                border-bottom: 1px solid #e5e7eb;
            }

            /* Desktop work blocks */
            .work-block {
                position: absolute;
                background: #bfdbfe;
                border: 1px solid #3b82f6;
                border-radius: 4px;
                padding: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
                min-height: 15px;
                overflow: hidden;
                touch-action: manipulation;
            }

            .work-block:hover {
                background: #93c5fd;
                border-color: #2563eb;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                transform: translateY(-1px);
            }

            .work-block p {
                margin: 0;
                line-height: 1.2;
            }

            /* Mobile work blocks */
            .work-block-mobile {
                touch-action: manipulation;
                transition: all 0.2s ease;
            }

            .work-block-mobile:active {
                transform: scale(0.98);
            }

            /* Info balloon styles */
            #info-balloon {
                min-width: 280px;
                max-width: 400px;
                border: 2px solid #e5e7eb;
                box-shadow:
                    0 10px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
                z-index: 1000;
            }

            /* Desktop balloon arrows */
            @media (min-width: 640px) {
                #info-balloon::before {
                    content: "";
                    position: absolute;
                    top: 10px;
                    left: -8px;
                    width: 0;
                    height: 0;
                    border-top: 8px solid transparent;
                    border-bottom: 8px solid transparent;
                    border-right: 8px solid #e5e7eb;
                }
                #info-balloon::after {
                    content: "";
                    position: absolute;
                    top: 11px;
                    left: -6px;
                    width: 0;
                    height: 0;
                    border-top: 7px solid transparent;
                    border-bottom: 7px solid transparent;
                    border-right: 7px solid white;
                }
            }

            /* Mobile-specific styles */
            @media (max-width: 640px) {
                #info-balloon {
                    min-width: 280px;
                    max-width: 90vw;
                    border-radius: 12px;
                    backdrop-filter: blur(10px);
                }

                .container {
                    padding-left: 8px;
                    padding-right: 8px;
                }

                /* Improve touch targets */
                button,
                .cursor-pointer {
                    min-height: 44px;
                    min-width: 44px;
                }

                /* Better typography on mobile */
                h1 {
                    line-height: 1.2;
                }
            }

            /* Smooth scrolling */
            html {
                scroll-behavior: smooth;
            }

            /* Better focus styles for accessibility */
            button:focus,
            a:focus,
            input:focus {
                outline: 2px solid #3b82f6;
                outline-offset: 2px;
            }

            /* Loading states */
            .htmx-request {
                opacity: 0.7;
                transition: opacity 0.2s ease;
            }

            /* Prevent horizontal scrolling issues */
            body {
                overflow-x: hidden;
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen">
        <div class="container mx-auto p-2 sm:p-4">
            {% block content %} {% endblock %}
        </div>

        <!-- Changelog Modal -->
        <div
            id="changelog-modal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
        >
            <div
                class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto shadow-xl border border-gray-200"
            >
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        Novidades e Atualizações
                    </h2>
                    <button
                        onclick="closeChangelogModal()"
                        class="text-gray-400 hover:text-gray-600"
                    >
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                            ></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-4 border-b border-gray-200">
                    <ul
                        class="flex flex-wrap -mb-px text-sm font-medium text-center"
                        role="tablist"
                    >
                        <li class="mr-2" role="presentation">
                            <button
                                class="inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active"
                                id="unread-tab"
                                data-tabs-target="#unread"
                                type="button"
                                role="tab"
                                aria-controls="unread"
                                aria-selected="true"
                                onclick="switchTab('unread')"
                            >
                                Não lidos
                                <span
                                    id="unread-badge"
                                    class="ml-2 bg-blue-500 text-white text-xs rounded-full px-2 py-0.5"
                                    >0</span
                                >
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button
                                class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
                                id="all-tab"
                                data-tabs-target="#all"
                                type="button"
                                role="tab"
                                aria-controls="all"
                                aria-selected="false"
                                onclick="switchTab('all')"
                            >
                                Todos
                            </button>
                        </li>
                    </ul>
                </div>

                <div id="tabs-content">
                    <div id="unread-tab-content" class="space-y-4">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div id="all-tab-content" class="hidden space-y-4">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button
                        onclick="markAllChangelogsSeen()"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                    >
                        Marcar todos como lidos
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Changelog Button -->
        <div
            id="changelog-button"
            class="fixed bottom-4 right-4 bg-blue-500 text-white rounded-full p-3 shadow-lg cursor-pointer hidden hover:bg-blue-600 transition-all z-40 group"
            onclick="openChangelogModal()"
            title="Ver registo de alterações"
        >
            <div class="relative">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                </svg>
                <span
                    id="changelog-badge"
                    class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                    >0</span
                >
                <button
                    onclick="closeChangelogButton(event)"
                    class="absolute -top-2 -right-2 bg-gray-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500"
                    title="Fechar botão de atualizações"
                >
                    <span class="text-sm font-bold">×</span>
                </button>
            </div>
        </div>

        <!-- Changelog JavaScript -->
        <script>
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            document.addEventListener('DOMContentLoaded', function() {
                // Only check changelogs for staff users
                {% if user.is_authenticated and user.is_staff %}
                    loadChangelogs();

                    // Always show the changelog button for admins, unless manually closed
                    if (localStorage.getItem('changelog_button_closed') !== 'true') {
                        // Show immediately to prevent flashing
                        document.getElementById('changelog-button').classList.remove('hidden');
                    }
                {% endif %}
            });

            function loadChangelogs() {
                fetch('/api/changelogs/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update the badge count with unseen count
                            const badge = document.getElementById('changelog-badge');
                            badge.textContent = data.unseen_count;

                            // Remove the localStorage setting so button will appear on next load
                            localStorage.removeItem('changelog_button_closed');

                            // Always show the changelog button for admins, but hide the badge if no new items
                            if (data.unseen_count > 0) {
                                badge.classList.remove('hidden');
                                badge.classList.add('animate-pulse');

                                // Pulse animation for 3 seconds
                                setTimeout(() => {
                                    badge.classList.remove('animate-pulse');
                                }, 3000);

                                // If this is after login, show the modal automatically
                                {% if request.session.check_changelogs %}
                                    openChangelogModal();
                                    // Reset the flag
                                    fetch('/api/changelogs/check-done/', {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': getCookie('csrftoken')
                                        }
                                    });
                                {% endif %}
                            } else {
                                badge.classList.add('hidden');
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching changelogs:', error));
            }

            function switchTab(tabName) {
                // Hide all tab contents
                document.getElementById('unread-tab-content').classList.add('hidden');
                document.getElementById('all-tab-content').classList.add('hidden');

                // Show selected tab content
                document.getElementById(tabName + '-tab-content').classList.remove('hidden');

                // Update tab styling
                document.getElementById('unread-tab').className = 'inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300';
                document.getElementById('all-tab').className = 'inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300';

                document.getElementById(tabName + '-tab').className = 'inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active';
            }

            function openChangelogModal() {
                // Get the changelog content
                fetch('/api/changelogs/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update unread badge count
                            const unreadBadge = document.getElementById('unread-badge');
                            unreadBadge.textContent = data.unseen_count;

                            // Populate the unread tab content
                            const unreadContent = document.getElementById('unread-tab-content');
                            unreadContent.innerHTML = '';

                            // Populate the all tab content
                            const allContent = document.getElementById('all-tab-content');
                            allContent.innerHTML = '';

                            // Check if there are any unread changelogs
                            let hasUnread = false;

                            data.changelogs.forEach(changelog => {
                                const item = document.createElement('div');

                                // Create item HTML
                                let itemClass = 'p-4 rounded-lg mb-3 transition-all duration-200';
                                if (changelog.is_unseen) {
                                    itemClass += ' bg-blue-50 border-l-4 border-blue-500 shadow-sm hover:shadow';
                                    hasUnread = true;
                                } else {
                                    itemClass += ' bg-gray-50 hover:bg-gray-100';
                                }

                                item.className = itemClass;
                                item.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <h3 class="text-lg font-semibold text-gray-700">${changelog.title}</h3>
                                        <span class="text-xs bg-gray-200 rounded-full px-2 py-1">${changelog.date_added}</span>
                                    </div>
                                    <div class="mt-2 prose prose-sm max-w-none">${changelog.description}</div>
                                `;

                                // Add to appropriate tab(s)
                                allContent.appendChild(item.cloneNode(true));

                                if (changelog.is_unseen) {
                                    unreadContent.appendChild(item);
                                }
                            });

                            // If no unread items, show a message
                            if (!hasUnread) {
                                const emptyState = document.createElement('div');
                                emptyState.className = 'text-center py-8 text-gray-500';
                                emptyState.innerHTML = `
                                    <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p>Não existem atualizações por ler</p>
                                    <p class="text-sm mt-1">Todas as atualizações foram marcadas como lidas</p>
                                `;
                                unreadContent.appendChild(emptyState);

                                // Switch to all tab if there are no unread items
                                switchTab('all');
                            } else {
                                // Make sure we're on the unread tab
                                switchTab('unread');
                            }

                            // Show the modal
                            document.getElementById('changelog-modal').classList.remove('hidden');
                        }
                    })
                    .catch(error => console.error('Error fetching changelog details:', error));
            }

            function closeChangelogModal() {
                document.getElementById('changelog-modal').classList.add('hidden');
            }

            function markAllChangelogsSeen() {
                fetch('/api/changelogs/mark-all-seen/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the main badge count to 0
                        const badge = document.getElementById('changelog-badge');
                        badge.textContent = '0';
                        badge.classList.add('hidden');

                        // Update the tab badge count
                        const unreadBadge = document.getElementById('unread-badge');
                        unreadBadge.textContent = '0';

                        // Show the empty state for unread tab
                        const unreadContent = document.getElementById('unread-tab-content');
                        unreadContent.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p>Não existem atualizações por ler</p>
                                <p class="text-sm mt-1">Todas as atualizações foram marcadas como lidas</p>
                            </div>
                        `;

                        // Update the all tab content with non-highlighted items
                        if (data.changelogs) {
                            const allContent = document.getElementById('all-tab-content');
                            allContent.innerHTML = '';

                            data.changelogs.forEach(changelog => {
                                const item = document.createElement('div');
                                item.className = 'bg-gray-50 p-4 rounded-lg mb-3 hover:bg-gray-100 transition-all duration-200';
                                item.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <h3 class="text-lg font-semibold text-gray-700">${changelog.title}</h3>
                                        <span class="text-xs bg-gray-200 rounded-full px-2 py-1">${changelog.date_added}</span>
                                    </div>
                                    <div class="mt-2 prose prose-sm max-w-none">${changelog.description}</div>
                                `;
                                allContent.appendChild(item);
                            });
                        }

                        // Switch to the all tab since there are no unread items
                        switchTab('all');

                        // Show success notification
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md z-50 transform transition-all duration-500 ease-in-out';
                        notification.style.opacity = '0';
                        notification.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>Todas as atualizações marcadas como lidas</span>
                            </div>
                        `;
                        document.body.appendChild(notification);

                        // Fade in
                        setTimeout(() => {
                            notification.style.opacity = '1';
                        }, 10);

                        // Remove notification after 3 seconds
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            setTimeout(() => {
                                notification.remove();
                            }, 500);
                        }, 3000);
                    }
                })
                .catch(error => console.error('Error marking changelogs as seen:', error));
            }

            function closeChangelogButton(event) {
                // Prevent the click from opening the modal
                event.stopPropagation();

                // Hide the changelog button temporarily until page reload
                document.getElementById('changelog-button').classList.add('hidden');

                // Store in localStorage that the button has been closed
                localStorage.setItem('changelog_button_closed', 'true');
            }
        </script>
    </body>
</html>
