{% extends 'base.html' %} {% load humanize %} {% block content %}
<div class="container mx-auto p-4">
    <!-- htmx target for schedule content -->
    <div id="schedule-content" class="bg-white rounded shadow">
        <div id="schedule-inner">
            <!-- Navigation moved inside the HTMX target for proper updating -->
            <div
                class="flex justify-between items-center mb-4 p-4 border-b"
                id="nav-bar"
            >
                <div class="flex items-center space-x-3">
                    <h1 class="text-2xl font-bold" id="schedule-title">
                        Admin Schedule: {{ week_start_formatted }} - {{
                        week_end_formatted }}
                    </h1>
                    <button
                        id="exit-zoom-btn"
                        onclick="exitDayZoom()"
                        class="hidden px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
                        title="Exit zoom mode"
                    >
                        Exit Zoom
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <a
                        href="{% url 'admin_schedule_week' prev_week.year prev_week.week %}"
                        hx-get="{% url 'admin_schedule_week' prev_week.year prev_week.week %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >Previous Week</a
                    >
                    <a
                        href="{% url 'admin_schedule' %}"
                        hx-get="{% url 'admin_schedule' %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                        >Current Week</a
                    >
                    <a
                        href="{% url 'admin_schedule_week' next_week.year next_week.week %}"
                        hx-get="{% url 'admin_schedule_week' next_week.year next_week.week %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >Next Week</a
                    >
                    <a
                        href="{% url 'admin_statistics' %}"
                        class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
                        >Statistics</a
                    >
                    <a
                        href="/admin/"
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                        >Admin Dashboard</a
                    >
                </div>
            </div>
            <!-- Hidden data for JavaScript -->
            {{ block_data_json|json_script:"block-data" }}

            <!-- Schedule grid -->
            <div
                id="schedule-grid"
                class="grid grid-cols-[100px_repeat(7,1fr)] p-4 transition-all duration-300 ease-in-out"
                style="min-width: 0; position: relative"
            >
                <!-- Time column -->
                <div
                    class="border-r border-gray-400"
                    style="position: relative"
                >
                    <div class="h-12 border-b border-gray-400"></div>
                    {% for slot in time_slots %}
                    <div
                        class="time-slot flex items-center px-2 text-sm border-b border-gray-300"
                        style="height: 40px"
                    >
                        {{ slot.0 }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Day columns -->
                {% for day in days %}
                <div
                    class="day-column relative border-r border-gray-400 transition-all duration-300 ease-in-out"
                    style="position: relative"
                    data-day-index="{{ forloop.counter0 }}"
                >
                    <div
                        class="h-12 text-center font-semibold border-b border-gray-400 flex items-center justify-center cursor-pointer hover:bg-blue-50 transition-all duration-200 ease-in-out"
                        onclick="toggleDayZoom({{ forloop.counter0 }})"
                        title="Click to zoom into this day"
                    >
                        {{ day.date|date:"D, d M" }}
                    </div>

                    <!-- Time slot grid background -->
                    {% for slot in time_slots %}
                    <div
                        class="time-slot border-b border-gray-300"
                        style="height: 40px"
                    ></div>
                    {% endfor %}

                    <!-- Work blocks -->
                    {% for block_data in day.blocks %}
                    <div
                        class="work-block cursor-pointer absolute {% if block_data.block.archived %}bg-gray-300 border border-gray-500{% else %}bg-blue-200 border border-blue-400{% endif %} rounded px-2 py-1 text-xs overflow-hidden {% if block_data.block.archived %}hover:bg-gray-400{% else %}hover:bg-blue-300{% endif %} transition-all duration-300 ease-in-out"
                        style="top: {{ block_data.top }}px; height: {{ block_data.height }}px; width: {{ block_data.width }}%; left: {{ block_data.left }}%; z-index: 10;"
                        onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
                        title="Click for details"
                    >
                        <p
                            class="font-semibold {% if block_data.block.archived %}text-gray-700{% else %}text-blue-800{% endif %} break-words"
                        >
                            {{ block_data.block.name|default:"Work Block" }} {% if block_data.block.archived  %}
                            <span class="text-gray-500 italic">(Archived)</span>
                            {% endif %}
                        </p>
                        {% if block_data.height > 25 %}
                        <p
                            class="{% if block_data.block.archived %}text-gray-600{% else %}text-blue-600{% endif %} break-words"
                        >
                            {{ block_data.block.localization|default:"" }}
                        </p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Information balloon -->
    <div
        id="info-balloon"
        class="absolute bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden z-50 max-w-xs"
    >
        <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-gray-800" id="balloon-title"></h3>
            <button
                onclick="hideBlockInfo()"
                class="text-gray-400 hover:text-gray-600 ml-2"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>
        <div id="balloon-content" class="text-sm text-gray-600 space-y-1">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Employee Assignment Modal -->
    <div
        id="employee-assignment-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
    >
        <div
            class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    Assign Employees
                </h2>
                <button
                    onclick="closeEmployeeModal()"
                    class="text-gray-400 hover:text-gray-600"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        ></path>
                    </svg>
                </button>
            </div>

            <div class="mb-4">
                <h3
                    id="modal-work-block-title"
                    class="text-lg font-semibold text-gray-700"
                ></h3>
                <p
                    id="modal-work-block-details"
                    class="text-sm text-gray-600"
                ></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Available Employees -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4
                        class="font-semibold text-gray-700 mb-3 flex items-center"
                    >
                        <svg
                            class="w-5 h-5 mr-2 text-blue-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                            ></path>
                        </svg>
                        Available Employees
                    </h4>
                    <div
                        id="available-employees"
                        class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                    >
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Assigned Employees -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h4
                        class="font-semibold text-gray-700 mb-3 flex items-center"
                    >
                        <svg
                            class="w-5 h-5 mr-2 text-green-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                        Assigned Employees
                    </h4>
                    <div
                        id="assigned-employees"
                        class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                    >
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button
                    onclick="closeEmployeeModal()"
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                >
                    Cancel
                </button>
                <button
                    onclick="saveEmployeeAssignments()"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                >
                    Save Assignments
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Work Block Modal -->
    <div
        id="edit-work-block-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
    >
        <div
            class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Edit Work Block</h2>
                <button
                    onclick="closeEditModal()"
                    class="text-gray-400 hover:text-gray-600"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        ></path>
                    </svg>
                </button>
            </div>

            <form id="edit-work-block-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Name</label
                        >
                        <input
                            type="text"
                            id="edit-name"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Location</label
                        >
                        <input
                            type="text"
                            id="edit-localization"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Client</label
                        >
                        <select
                            id="edit-client"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Select Client</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Duration (HH:MM)</label
                        >
                        <input
                            type="text"
                            id="edit-duration"
                            placeholder="00:00"
                            pattern="[0-9]{1,2}:[0-9]{2}"
                            maxlength="5"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Start Time (HH:MM or HH:MM:SS)</label
                        >
                        <input
                            type="text"
                            id="edit-start-time"
                            placeholder="00:00 or 00:00:00"
                            pattern="[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?"
                            maxlength="8"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >End Time (HH:MM or HH:MM:SS)</label
                        >
                        <input
                            type="text"
                            id="edit-end-time"
                            placeholder="00:00 or 00:00:00"
                            pattern="[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?"
                            maxlength="8"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Hourly Value (€)</label
                        >
                        <input
                            type="number"
                            step="0.01"
                            id="edit-hourly-value"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">
                        Employee Assignments
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Available Employees for Edit -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4
                                class="font-semibold text-gray-700 mb-3 flex items-center"
                            >
                                <svg
                                    class="w-5 h-5 mr-2 text-blue-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                                    ></path>
                                </svg>
                                Available Employees
                            </h4>
                            <div
                                id="edit-available-employees"
                                class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                            >
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Assigned Employees for Edit -->
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4
                                class="font-semibold text-gray-700 mb-3 flex items-center"
                            >
                                <svg
                                    class="w-5 h-5 mr-2 text-green-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                                Assigned Employees
                            </h4>
                            <div
                                id="edit-assigned-employees"
                                class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                            >
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button
                        type="button"
                        onclick="closeEditModal()"
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="button"
                        onclick="saveWorkBlockEdit()"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
                    >
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        var blockData = {};
        var currentBalloon = null;

        // Load block data when page loads or when HTMX updates content
        function loadBlockData() {
            try {
                const blockDataElement = document.getElementById("block-data");
                if (blockDataElement) {
                    blockData = JSON.parse(blockDataElement.textContent);
                    console.log("Block data loaded:", blockData);
                }
            } catch (e) {
                console.error("Error parsing block data:", e);
                blockData = {};
            }
        }

        // Update navigation buttons
        function updateNavigation() {
            // Get current navigation data from the DOM
            const currentTitle =
                document.getElementById("schedule-title").textContent;
            console.log("Current title:", currentTitle);

            // Log navigation button states
            const navButtons = document.querySelectorAll("#nav-bar a");
            console.log("Navigation buttons found:", navButtons.length);
            if (navButtons.length >= 3) {
                console.log("Previous button href:", navButtons[0].href);
                console.log("Next button href:", navButtons[2].href);
            }
        }

        // Load on initial page load
        document.addEventListener("DOMContentLoaded", loadBlockData);

        // Load after HTMX updates content
        document.addEventListener("htmx:afterSwap", function (event) {
            loadBlockData();

            // Reinitialize zoom functionality if the target was schedule-inner
            if (event.detail.target.id === "schedule-inner") {
                // Reset zoom state
                isZoomedIn = false;
                zoomedDayIndex = null;
                originalWorkBlockStyles.clear();

                // Hide exit zoom button if it exists
                const exitBtn = document.getElementById("exit-zoom-btn");
                if (exitBtn) {
                    exitBtn.classList.add("hidden");
                }

                console.log("Zoom functionality reinitialized after HTMX swap");
            }

            // Add a small delay to ensure the navigation buttons are properly updated
            setTimeout(function () {
                console.log(
                    "DEBUG: HTMX swap completed, navigation should be updated",
                );
            }, 150);
        });

        function showBlockInfo(blockId, element, event) {
            event.stopPropagation();

            console.log("Showing info for block:", blockId);

            const balloon = document.getElementById("info-balloon");
            const title = document.getElementById("balloon-title");
            const content = document.getElementById("balloon-content");

            const block = blockData[blockId];
            if (!block) {
                console.error("Block not found:", blockId);
                return;
            }

            // Populate balloon content
            title.textContent = block.name || "Work Block";

            const employeesAssigned =
                block.employees_assigned.length > 0
                    ? block.employees_assigned.join(", ")
                    : "Empty";
            const employeesConcluded =
                block.employees_concluded.length > 0
                    ? block.employees_concluded.join(", ")
                    : "Empty";

            content.innerHTML = `
                <div><strong>Time:</strong> ${block.start_time} - ${block.end_time}</div>
                <div><strong>Duration:</strong> ${block.duration}</div>
                <div><strong>Hourly Value:</strong> €${block.hourly_value}/h</div>
                <div><strong>Location:</strong> ${block.localization}</div>
                <div><strong>Client:</strong> ${block.client}</div>
                <div><strong>Assigned:</strong> ${employeesAssigned}</div>
                <div><strong>Concluded:</strong> ${employeesConcluded}</div>
                <div><strong>Constant:</strong> ${block.constant ? "Yes" : "No"}</div>
                ${block.archived ? '<div class="text-red-500"><strong>Archived</strong></div>' : ""}
                <div class="mt-3 space-y-2">
                    <button onclick="openEmployeeModal('${blockId}')" class="w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium transition-colors">
                        Assign Employees
                    </button>
                    <button onclick="openEditModal('${blockId}')" class="w-full px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium transition-colors">
                        Edit Work Block
                    </button>
                    <button onclick="toggleArchiveBlock('${blockId}')" class="w-full px-3 py-2 ${block.archived ? "bg-yellow-500 hover:bg-yellow-600" : "bg-orange-500 hover:bg-orange-600"} text-white rounded text-sm font-medium transition-colors">
                        ${block.archived ? "Unarchive" : "Archive"} Block
                    </button>
                    <button onclick="deleteBlock('${blockId}')" class="w-full px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm font-medium transition-colors">
                        Delete Block
                    </button>
                </div>
            `;

            // Show balloon first to get proper dimensions
            balloon.classList.remove("hidden");

            // Position balloon next to the clicked element
            const rect = element.getBoundingClientRect();
            const balloonRect = balloon.getBoundingClientRect();
            const scrollTop =
                window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft =
                window.pageXOffset || document.documentElement.scrollLeft;

            let left = rect.right + scrollLeft + 10;
            let top = rect.top + scrollTop;

            // Adjust if balloon would go off screen
            if (left + balloonRect.width > window.innerWidth + scrollLeft) {
                left = rect.left + scrollLeft - balloonRect.width - 10;
            }
            if (top + balloonRect.height > window.innerHeight + scrollTop) {
                top = rect.bottom + scrollTop - balloonRect.height;
            }

            // Ensure balloon doesn't go off the left edge
            if (left < scrollLeft) {
                left = scrollLeft + 10;
            }

            // Ensure balloon doesn't go off the top edge
            if (top < scrollTop) {
                top = scrollTop + 10;
            }

            balloon.style.left = left + "px";
            balloon.style.top = top + "px";

            currentBalloon = balloon;
        }

        function hideBlockInfo() {
            const balloon = document.getElementById("info-balloon");
            balloon.classList.add("hidden");
            currentBalloon = null;
        }

        // Hide balloon when clicking outside
        document.addEventListener("click", function (event) {
            if (
                currentBalloon &&
                !currentBalloon.contains(event.target) &&
                !event.target.closest(".work-block")
            ) {
                hideBlockInfo();
            }
        });

        // Hide balloon when scrolling
        document.addEventListener("scroll", function () {
            if (currentBalloon) {
                hideBlockInfo();
            }
        });

        // Hide balloon when pressing Escape key
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape" && currentBalloon) {
                hideBlockInfo();
            }
        });

        // Employee Assignment Modal Functions
        let currentBlockId = null;
        let allEmployees = [];
        let currentAssignments = [];

        // Load all employees data
        function loadEmployeesData() {
            fetch("/api/employees/")
                .then((response) => response.json())
                .then((data) => {
                    allEmployees = data;
                })
                .catch((error) =>
                    console.error("Error loading employees:", error),
                );
        }

        function openEmployeeModal(blockId) {
            currentBlockId = blockId;
            const block = blockData[blockId];

            if (!block) {
                console.error("Block not found:", blockId);
                return;
            }

            // Update modal title and details
            document.getElementById("modal-work-block-title").textContent =
                block.name || "Work Block";
            document.getElementById("modal-work-block-details").textContent =
                `${block.start_time} - ${block.end_time} • ${block.localization} • ${block.client}`;

            // Load current assignments
            fetch(`/api/work-block/${blockId}/assignments/`)
                .then((response) => response.json())
                .then((data) => {
                    currentAssignments = data.assigned_employees || [];
                    updateEmployeeModalLists();
                    document
                        .getElementById("employee-assignment-modal")
                        .classList.remove("hidden");
                })
                .catch((error) => {
                    console.error("Error loading assignments:", error);
                    // Fallback to block data
                    currentAssignments = block.employees_assigned || [];
                    updateEmployeeModalLists();
                    document
                        .getElementById("employee-assignment-modal")
                        .classList.remove("hidden");
                });

            hideBlockInfo();
        }

        function updateEmployeeModalLists() {
            const availableContainer = document.getElementById(
                "available-employees",
            );
            const assignedContainer =
                document.getElementById("assigned-employees");

            availableContainer.innerHTML = "";
            assignedContainer.innerHTML = "";

            // Load all employees if not already loaded
            if (allEmployees.length === 0) {
                loadEmployeesData();
                // If still empty, get from block data as fallback
                if (allEmployees.length === 0) {
                    const allEmployeeNames = new Set();
                    Object.values(blockData).forEach((block) => {
                        block.employees_assigned.forEach((name) =>
                            allEmployeeNames.add(name),
                        );
                    });
                    allEmployees = Array.from(allEmployeeNames).map((name) => ({
                        name,
                    }));
                }
            }

            // Create employee items
            allEmployees.forEach((employee) => {
                const employeeName = employee.name;
                const isAssigned = currentAssignments.includes(employeeName);
                const employeeItem = createEmployeeItem(
                    employeeName,
                    isAssigned,
                );

                if (isAssigned) {
                    assignedContainer.appendChild(employeeItem);
                } else {
                    availableContainer.appendChild(employeeItem);
                }
            });

            // Add empty state messages
            if (availableContainer.children.length === 0) {
                availableContainer.innerHTML =
                    '<div class="text-gray-500 text-center py-8">All employees are assigned</div>';
            }
            if (assignedContainer.children.length === 0) {
                assignedContainer.innerHTML =
                    '<div class="text-gray-500 text-center py-8">No employees assigned</div>';
            }
        }

        function createEmployeeItem(employeeName, isAssigned) {
            const div = document.createElement("div");
            div.className = `employee-item p-3 bg-white rounded-lg shadow-sm border cursor-pointer hover:shadow-md transition-all ${isAssigned ? "border-green-200" : "border-gray-200"}`;
            div.draggable = true;
            div.dataset.employeeName = employeeName;

            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-medium text-gray-700">
                            ${employeeName.charAt(0).toUpperCase()}
                        </div>
                        <span class="ml-3 font-medium text-gray-700">${employeeName}</span>
                    </div>
                    <button onclick="toggleEmployeeAssignment('${employeeName}')" class="text-sm px-2 py-1 rounded ${isAssigned ? "bg-red-100 text-red-600 hover:bg-red-200" : "bg-green-100 text-green-600 hover:bg-green-200"} transition-colors">
                        ${isAssigned ? "Remove" : "Assign"}
                    </button>
                </div>
            `;

            // Add drag and drop functionality
            div.addEventListener("dragstart", (e) => {
                e.dataTransfer.setData("text/plain", employeeName);
                div.classList.add("opacity-50");
            });

            div.addEventListener("dragend", () => {
                div.classList.remove("opacity-50");
            });

            return div;
        }

        function toggleEmployeeAssignment(employeeName) {
            const index = currentAssignments.indexOf(employeeName);
            if (index > -1) {
                currentAssignments.splice(index, 1);
            } else {
                currentAssignments.push(employeeName);
            }
            updateEmployeeModalLists();
        }

        function setupDropZones() {
            const availableContainer = document.getElementById(
                "available-employees",
            );
            const assignedContainer =
                document.getElementById("assigned-employees");

            [availableContainer, assignedContainer].forEach((container) => {
                container.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    container.classList.add("bg-blue-50", "border-blue-300");
                });

                container.addEventListener("dragleave", () => {
                    container.classList.remove("bg-blue-50", "border-blue-300");
                });

                container.addEventListener("drop", (e) => {
                    e.preventDefault();
                    container.classList.remove("bg-blue-50", "border-blue-300");

                    const employeeName = e.dataTransfer.getData("text/plain");
                    const isAssignedContainer =
                        container.id === "assigned-employees";

                    if (
                        isAssignedContainer &&
                        !currentAssignments.includes(employeeName)
                    ) {
                        currentAssignments.push(employeeName);
                        updateEmployeeModalLists();
                    } else if (
                        !isAssignedContainer &&
                        currentAssignments.includes(employeeName)
                    ) {
                        const index = currentAssignments.indexOf(employeeName);
                        currentAssignments.splice(index, 1);
                        updateEmployeeModalLists();
                    }
                });
            });
        }

        function closeEmployeeModal() {
            document
                .getElementById("employee-assignment-modal")
                .classList.add("hidden");
            currentBlockId = null;
            currentAssignments = [];
        }

        function saveEmployeeAssignments() {
            if (!currentBlockId) return;

            const data = {
                block_id: currentBlockId,
                employee_names: currentAssignments,
            };

            fetch("/api/work-block/assign-employees/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Update the block data
                        blockData[currentBlockId].employees_assigned =
                            currentAssignments;
                        closeEmployeeModal();

                        // Refresh the page to show updated assignments
                        location.reload();
                    } else {
                        alert(
                            "Error: " +
                                (data.error || "Failed to save assignments"),
                        );
                    }
                })
                .catch((error) => {
                    console.error("Error saving assignments:", error);
                    alert("An error occurred while saving assignments");
                });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(
                            cookie.substring(name.length + 1),
                        );
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Convert decimal hours to HH:MM format
        function decimalToHoursMinutes(decimal) {
            const hours = Math.floor(decimal);
            const minutes = Math.round((decimal - hours) * 60);
            return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;
        }

        // Convert HH:MM format to decimal hours
        function hoursMinutesToDecimal(timeString) {
            if (!timeString || !timeString.includes(":")) {
                throw new Error(
                    "Invalid time format. Please use HH:MM format.",
                );
            }
            const [hours, minutes] = timeString.split(":").map(Number);
            if (
                isNaN(hours) ||
                isNaN(minutes) ||
                minutes >= 60 ||
                minutes < 0 ||
                hours < 0
            ) {
                throw new Error(
                    "Invalid time format. Please use HH:MM format.",
                );
            }
            return hours + minutes / 60;
        }

        // Format time input as user types
        function formatTimeInput(input) {
            let value = input.value.replace(/[^\d:]/g, "");
            if (value.length === 2 && !value.includes(":")) {
                value += ":";
            }
            if (value.length > 5) {
                value = value.substr(0, 5);
            }
            input.value = value;
        }

        // Format time input (accepts HH:MM or HH:MM:SS) as user types
        function formatFullTimeInput(input) {
            let value = input.value.replace(/[^\d:]/g, "");
            if (value.length === 2 && value.indexOf(":") === -1) {
                value += ":";
            }
            if (
                value.length === 5 &&
                value.split(":").length === 2 &&
                value.indexOf(":", 3) === -1
            ) {
                // Only add second colon if user continues typing past HH:MM
                if (input.value.length > value.length) {
                    value += ":";
                }
            }
            if (value.length > 8) {
                value = value.substr(0, 8);
            }
            input.value = value;
        }

        // Validate and normalize time format (accepts HH:MM or HH:MM:SS)
        function validateAndNormalizeTime(timeString) {
            if (!timeString) {
                throw new Error("Time is required.");
            }

            const parts = timeString.split(":");

            // Accept both HH:MM and HH:MM:SS formats
            if (parts.length === 2) {
                // HH:MM format - add :00 for seconds
                const [hours, minutes] = parts.map(Number);
                if (
                    isNaN(hours) ||
                    isNaN(minutes) ||
                    hours < 0 ||
                    hours >= 24 ||
                    minutes < 0 ||
                    minutes >= 60
                ) {
                    throw new Error(
                        "Invalid time values. Hours: 00-23, Minutes: 00-59.",
                    );
                }
                return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:00`;
            } else if (parts.length === 3) {
                // HH:MM:SS format
                const [hours, minutes, seconds] = parts.map(Number);
                if (
                    isNaN(hours) ||
                    isNaN(minutes) ||
                    isNaN(seconds) ||
                    hours < 0 ||
                    hours >= 24 ||
                    minutes < 0 ||
                    minutes >= 60 ||
                    seconds < 0 ||
                    seconds >= 60
                ) {
                    throw new Error(
                        "Invalid time values. Hours: 00-23, Minutes/Seconds: 00-59.",
                    );
                }
                return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
            } else {
                throw new Error(
                    "Invalid time format. Please use HH:MM or HH:MM:SS format.",
                );
            }
        }

        // Initialize drag and drop when modal opens
        document
            .getElementById("employee-assignment-modal")
            .addEventListener("transitionend", () => {
                if (
                    !document
                        .getElementById("employee-assignment-modal")
                        .classList.contains("hidden")
                ) {
                    setupDropZones();
                }
            });

        // Day zoom functionality
        let isZoomedIn = false;
        let zoomedDayIndex = null;
        let originalWorkBlockStyles = new Map();

        function toggleDayZoom(dayIndex) {
            const grid = document.getElementById("schedule-grid");
            const dayColumns = document.querySelectorAll(".day-column");

            if (isZoomedIn && zoomedDayIndex === dayIndex) {
                // Zoom out - restore original view
                exitDayZoom();
            } else {
                // Zoom in to this day
                enterDayZoom(dayIndex);
            }
        }

        function enterDayZoom(dayIndex) {
            const grid = document.getElementById("schedule-grid");
            const dayColumns = document.querySelectorAll(".day-column");
            const zoomedColumn = dayColumns[dayIndex];

            // Store original work block styles for restoration
            const workBlocks = zoomedColumn.querySelectorAll(".work-block");
            workBlocks.forEach((block, blockIndex) => {
                originalWorkBlockStyles.set(block, {
                    width: block.style.width,
                    left: block.style.left,
                });
            });

            // Hide all other day columns with animation
            dayColumns.forEach((column, index) => {
                if (index !== dayIndex) {
                    column.style.opacity = "0";
                    column.style.transform = "scaleX(0)";
                    setTimeout(() => {
                        column.style.display = "none";
                    }, 150);
                } else {
                    column.style.opacity = "1";
                    column.style.transform = "scaleX(1)";
                }
            });

            // Update grid to single column layout
            setTimeout(() => {
                grid.style.gridTemplateColumns = "100px 1fr";
            }, 150);

            // Recalculate work block positions for zoomed view
            recalculateWorkBlockPositions(zoomedColumn);

            // Update state
            isZoomedIn = true;
            zoomedDayIndex = dayIndex;

            // Add visual indicator
            const header = zoomedColumn.querySelector("div");
            const originalContent = header.innerHTML;
            header.style.backgroundColor = "#dbeafe";
            header.innerHTML =
                originalContent +
                ' <span class="text-xs text-blue-600 ml-2">(Click to zoom out or press ESC)</span>';
            header.dataset.originalContent = originalContent;

            // Show exit zoom button
            const exitBtn = document.getElementById("exit-zoom-btn");
            exitBtn.classList.remove("hidden");

            // Hide balloon if open
            hideBlockInfo();

            // Update title to show zoomed day
            const scheduleTitle = document.getElementById("schedule-title");
            const dayText = header.dataset.originalContent || originalContent;
            scheduleTitle.innerHTML = `Admin Schedule - Zoomed: ${dayText.trim()}`;
        }

        function recalculateWorkBlockPositions(dayColumn) {
            const workBlocks = Array.from(
                dayColumn.querySelectorAll(".work-block"),
            );

            // Group blocks by time overlap for better side-by-side positioning
            const timeGroups = [];

            workBlocks.forEach((block) => {
                const blockTop = parseInt(block.style.top);
                const blockHeight = parseInt(block.style.height);
                const blockBottom = blockTop + blockHeight;

                // Find existing group that overlaps with this block
                let foundGroup = timeGroups.find((group) => {
                    return group.some((groupBlock) => {
                        const groupTop = parseInt(groupBlock.style.top);
                        const groupHeight = parseInt(groupBlock.style.height);
                        const groupBottom = groupTop + groupHeight;

                        // Check if blocks overlap in time
                        return !(
                            blockBottom <= groupTop || blockTop >= groupBottom
                        );
                    });
                });

                if (foundGroup) {
                    foundGroup.push(block);
                } else {
                    timeGroups.push([block]);
                }
            });

            // Position blocks within each time group
            timeGroups.forEach((group) => {
                const groupSize = group.length;
                const blockWidth = Math.floor(98 / groupSize); // Leave some margin

                group.forEach((block, index) => {
                    block.style.width = `${blockWidth}%`;
                    block.style.left = `${index * blockWidth + 1}%`;

                    // Add more detailed styling for zoomed view
                    block.style.minWidth = "120px";
                    block.style.fontSize = "14px";
                    block.style.padding = "8px";

                    // Show more details when zoomed
                    const blockElement = block;
                    if (!blockElement.dataset.originalPadding) {
                        blockElement.dataset.originalPadding =
                            blockElement.style.padding;
                        blockElement.dataset.originalFontSize =
                            blockElement.style.fontSize;
                    }
                });
            });
        }

        function exitDayZoom() {
            const grid = document.getElementById("schedule-grid");
            const dayColumns = document.querySelectorAll(".day-column");

            // Restore original grid layout first
            grid.style.gridTemplateColumns = "";

            // Restore all day columns with animation
            dayColumns.forEach((column, index) => {
                column.style.display = "block";
                column.style.opacity = "0";
                column.style.transform = "scaleX(0)";

                setTimeout(() => {
                    column.style.opacity = "1";
                    column.style.transform = "scaleX(1)";
                }, 50 * index);
            });

            // Restore work block positions
            if (zoomedDayIndex !== null) {
                const zoomedColumn = dayColumns[zoomedDayIndex];
                const workBlocks = zoomedColumn.querySelectorAll(".work-block");

                workBlocks.forEach((block) => {
                    const original = originalWorkBlockStyles.get(block);
                    if (original) {
                        block.style.width = original.width;
                        block.style.left = original.left;

                        // Restore original styling
                        block.style.minWidth = "";
                        block.style.fontSize = "";
                        block.style.padding =
                            block.dataset.originalPadding || "";
                    }
                });

                // Remove visual indicator
                const header = zoomedColumn.querySelector("div");
                header.style.backgroundColor = "";
                header.innerHTML =
                    header.dataset.originalContent ||
                    header.innerHTML.replace(
                        / <span class="text-xs text-blue-600 ml-2">\([^)]+\)<\/span>/,
                        "",
                    );
                delete header.dataset.originalContent;
            }

            // Clear stored styles
            originalWorkBlockStyles.clear();

            // Hide exit zoom button
            const exitBtn = document.getElementById("exit-zoom-btn");
            exitBtn.classList.add("hidden");

            // Restore original title
            const scheduleTitle = document.getElementById("schedule-title");
            scheduleTitle.innerHTML =
                "Admin Schedule: {{ week_start_formatted }} - {{ week_end_formatted }}";

            // Reset state
            isZoomedIn = false;
            zoomedDayIndex = null;
        }

        // Add keyboard shortcut to exit zoom
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape" && isZoomedIn) {
                exitDayZoom();
            }
        });

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", () => {
            setupDropZones();
            loadEmployeesData();
        });

        // New functions for work block management
        let currentEditBlockId = null;
        let editBlockData = null;
        let editAllEmployees = [];
        let editCurrentAssignments = [];

        function deleteBlock(blockId) {
            if (
                !confirm(
                    "Are you sure you want to delete this work block? This action cannot be undone.",
                )
            ) {
                return;
            }

            fetch(`/api/work-block/${blockId}/delete/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        hideBlockInfo();
                        // Reload the schedule
                        location.reload();
                    } else {
                        alert("Error deleting work block: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error deleting work block");
                });
        }

        function toggleArchiveBlock(blockId) {
            const block = blockData[blockId];
            const action = block.archived ? "unarchive" : "archive";

            if (
                !confirm(`Are you sure you want to ${action} this work block?`)
            ) {
                return;
            }

            fetch(`/api/work-block/${blockId}/toggle-archive/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        hideBlockInfo();
                        // Reload the schedule
                        location.reload();
                    } else {
                        alert("Error archiving work block: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error archiving work block");
                });
        }

        function openEditModal(blockId) {
            currentEditBlockId = blockId;

            // Load work block details
            fetch(`/api/work-block/${blockId}/details/`)
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        editBlockData = data.work_block;

                        // Populate form fields
                        document.getElementById("edit-name").value =
                            editBlockData.name;
                        document.getElementById("edit-localization").value =
                            editBlockData.localization;
                        const startTimeInput =
                            document.getElementById("edit-start-time");
                        const endTimeInput =
                            document.getElementById("edit-end-time");

                        // Ensure times are displayed in HH:MM:SS format
                        startTimeInput.value =
                            editBlockData.start_time.includes(":") &&
                            editBlockData.start_time.split(":").length === 2
                                ? editBlockData.start_time + ":00"
                                : editBlockData.start_time;
                        endTimeInput.value =
                            editBlockData.end_time.includes(":") &&
                            editBlockData.end_time.split(":").length === 2
                                ? editBlockData.end_time + ":00"
                                : editBlockData.end_time;

                        // Add input formatting for time fields
                        startTimeInput.addEventListener("input", function (e) {
                            formatFullTimeInput(e.target);
                        });
                        endTimeInput.addEventListener("input", function (e) {
                            formatFullTimeInput(e.target);
                        });
                        const durationInput =
                            document.getElementById("edit-duration");
                        durationInput.value = decimalToHoursMinutes(
                            editBlockData.duration,
                        );

                        // Add input formatting for duration field
                        durationInput.addEventListener("input", function (e) {
                            let value = e.target.value.replace(/[^\d:]/g, "");
                            if (value.length === 2 && !value.includes(":")) {
                                value += ":";
                            }
                            if (value.length > 5) {
                                value = value.substr(0, 5);
                            }
                            e.target.value = value;
                        });
                        document.getElementById("edit-hourly-value").value =
                            editBlockData.hourly_value;

                        // Populate client dropdown
                        const clientSelect =
                            document.getElementById("edit-client");
                        clientSelect.innerHTML =
                            '<option value="">Select Client</option>';
                        data.clients.forEach((client) => {
                            const option = document.createElement("option");
                            option.value = client;
                            option.textContent = client;
                            if (client === editBlockData.client) {
                                option.selected = true;
                            }
                            clientSelect.appendChild(option);
                        });

                        // Set up employee assignments
                        editCurrentAssignments = editBlockData.employees.map(
                            (emp) => ({
                                name: emp.name,
                                duration: emp.duration,
                                is_completed: emp.is_completed,
                                receives_payment: emp.receives_payment,
                                contract_hourly_rate: emp.contract_hourly_rate,
                                has_contract: emp.has_contract,
                                hourly_rate_override: emp.hourly_rate_override,
                                effective_hourly_rate:
                                    emp.effective_hourly_rate,
                            }),
                        );

                        updateEditEmployeeModalLists();
                        document
                            .getElementById("edit-work-block-modal")
                            .classList.remove("hidden");
                    } else {
                        alert(
                            "Error loading work block details: " + data.error,
                        );
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error loading work block details");
                });

            hideBlockInfo();
        }

        function closeEditModal() {
            document
                .getElementById("edit-work-block-modal")
                .classList.add("hidden");
            currentEditBlockId = null;
            editBlockData = null;
            editCurrentAssignments = [];
        }

        function updateEditEmployeeModalLists() {
            const availableContainer = document.getElementById(
                "edit-available-employees",
            );
            const assignedContainer = document.getElementById(
                "edit-assigned-employees",
            );

            // Clear containers
            availableContainer.innerHTML = "";
            assignedContainer.innerHTML = "";

            // Get assigned employee names
            const assignedNames = editCurrentAssignments.map((emp) => emp.name);

            // Add available employees
            allEmployees.forEach((employee) => {
                if (!assignedNames.includes(employee.name)) {
                    const item = createEditEmployeeItem(employee.name, false);
                    availableContainer.appendChild(item);
                }
            });

            // Add assigned employees
            editCurrentAssignments.forEach((assignment) => {
                const item = createEditEmployeeItem(
                    assignment.name,
                    true,
                    assignment,
                );
                assignedContainer.appendChild(item);
            });
        }

        function createEditEmployeeItem(
            employeeName,
            isAssigned,
            assignment = null,
        ) {
            const div = document.createElement("div");
            div.className = `p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors`;

            if (isAssigned && assignment) {
                const contractInfo = assignment.has_contract
                    ? `<div class="text-xs text-blue-600 mb-1">Contract: €${assignment.contract_hourly_rate}/h</div>`
                    : "";

                const effectiveRateInfo = `<div class="text-xs text-green-600 mb-1">Effective Rate: €${assignment.effective_hourly_rate}/h</div>`;

                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-800">${employeeName}</span>
                        <button onclick="toggleEditEmployeeAssignment('${employeeName}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    ${contractInfo}
                    ${effectiveRateInfo}
                    <div class="mt-2 space-y-2">
                        <div>
                            <label class="block text-xs text-gray-500">Duration (HH:MM)</label>
                            <input type="text" value="${decimalToHoursMinutes(assignment.duration)}" placeholder="00:00"
                                   pattern="[0-9]{1,2}:[0-9]{2}" maxlength="5"
                                   onchange="updateEditEmployeeDuration('${employeeName}', this.value)"
                                   oninput="formatTimeInput(this)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500">Hourly Rate Override (€)</label>
                            <input type="number" step="0.01" value="${assignment.hourly_rate_override || ""}" placeholder="Override rate"
                                   onchange="updateEditEmployeeHourlyRate('${employeeName}', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" ${assignment.is_completed ? "checked" : ""}
                                   onchange="updateEditEmployeeCompletion('${employeeName}', this.checked)"
                                   class="mr-2">
                            <label class="text-xs text-gray-500">Completed</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" ${assignment.receives_payment ? "checked" : ""}
                                   onchange="updateEditEmployeePayment('${employeeName}', this.checked)"
                                   class="mr-2">
                            <label class="text-xs text-gray-500">Receives Payment</label>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-800">${employeeName}</span>
                        <button onclick="toggleEditEmployeeAssignment('${employeeName}')" class="text-green-500 hover:text-green-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }

            return div;
        }

        function toggleEditEmployeeAssignment(employeeName) {
            const assignedIndex = editCurrentAssignments.findIndex(
                (emp) => emp.name === employeeName,
            );

            if (assignedIndex > -1) {
                // Remove from assigned
                editCurrentAssignments.splice(assignedIndex, 1);
            } else {
                // Add to assigned
                editCurrentAssignments.push({
                    name: employeeName,
                    duration: editBlockData.duration,
                    is_completed: false,
                });
            }

            updateEditEmployeeModalLists();
        }

        function updateEditEmployeeDuration(employeeName, duration) {
            const assignment = editCurrentAssignments.find(
                (a) => a.name === employeeName,
            );
            if (assignment) {
                try {
                    assignment.duration = hoursMinutesToDecimal(duration);
                } catch (error) {
                    alert(error.message);
                    // Reset to previous value on error
                    const input = document.querySelector(
                        `input[onchange*="${employeeName}"]`,
                    );
                    if (input) {
                        input.value = decimalToHoursMinutes(
                            assignment.duration,
                        );
                    }
                }
            }
        }

        function updateEditEmployeeCompletion(employeeName, isCompleted) {
            const assignment = editCurrentAssignments.find(
                (a) => a.name === employeeName,
            );
            if (assignment) {
                assignment.is_completed = isCompleted;
            }
        }

        function updateEditEmployeePayment(employeeName, receivesPayment) {
            const assignment = editCurrentAssignments.find(
                (a) => a.name === employeeName,
            );
            if (assignment) {
                assignment.receives_payment = receivesPayment;
            }
        }

        function updateEditEmployeeHourlyRate(employeeName, hourlyRate) {
            const assignment = editCurrentAssignments.find(
                (a) => a.name === employeeName,
            );
            if (assignment) {
                assignment.hourly_rate_override =
                    hourlyRate === "" ? null : parseFloat(hourlyRate);
                // Update effective rate display
                updateEditEmployeeModalLists();
            }
        }

        function saveWorkBlockEdit() {
            if (!currentEditBlockId) return;

            const formData = {
                name: document.getElementById("edit-name").value,
                localization:
                    document.getElementById("edit-localization").value,
                client: document.getElementById("edit-client").value,
                start_time: (() => {
                    const startTime =
                        document.getElementById("edit-start-time").value;
                    try {
                        return validateAndNormalizeTime(startTime);
                    } catch (error) {
                        alert("Start time error: " + error.message);
                        throw error;
                    }
                })(),
                end_time: (() => {
                    const endTime =
                        document.getElementById("edit-end-time").value;
                    try {
                        return validateAndNormalizeTime(endTime);
                    } catch (error) {
                        alert("End time error: " + error.message);
                        throw error;
                    }
                })(),
                duration: (() => {
                    try {
                        return hoursMinutesToDecimal(
                            document.getElementById("edit-duration").value,
                        );
                    } catch (error) {
                        alert(error.message);
                        throw error;
                    }
                })(),
                hourly_value: parseFloat(
                    document.getElementById("edit-hourly-value").value,
                ),
                employees: editCurrentAssignments,
            };

            fetch(`/api/work-block/${currentEditBlockId}/edit/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        closeEditModal();
                        // Reload the schedule
                        location.reload();
                    } else {
                        alert("Error updating work block: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error updating work block");
                });
        }
    </script>
</div>
{% endblock %}
