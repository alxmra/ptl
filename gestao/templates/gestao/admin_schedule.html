{% extends 'base.html' %} {% load humanize %} {% block content %}
<div class="container mx-auto p-4">
    <!-- htmx target for schedule content -->
    <div id="schedule-content" class="bg-white rounded shadow">
        <div id="schedule-inner">
            <!-- Navigation moved inside the HTMX target for proper updating -->
            <div
                class="flex justify-between items-center mb-4 p-4 border-b"
                id="nav-bar"
            >
                <h1 class="text-2xl font-bold" id="schedule-title">
                    Admin Schedule: {{ week_start_formatted }} - {{ week_end_formatted }}
                </h1>
                <div class="flex items-center space-x-2">
                    <a
                        href="{% url 'admin_schedule_week' prev_week.year prev_week.week %}"
                        hx-get="{% url 'admin_schedule_week' prev_week.year prev_week.week %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >Previous Week</a
                    >
                    <a
                        href="{% url 'admin_schedule' %}"
                        hx-get="{% url 'admin_schedule' %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                        >Current Week</a
                    >
                    <a
                        href="{% url 'admin_schedule_week' next_week.year next_week.week %}"
                        hx-get="{% url 'admin_schedule_week' next_week.year next_week.week %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >Next Week</a
                    >
                    <a
                        href="{% url 'admin_statistics' %}"
                        class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
                        >Statistics</a
                    >
                    <a
                        href="/admin/"
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                        >Admin Dashboard</a
                    >
                </div>
            </div>
            <!-- Hidden data for JavaScript -->
            {{ block_data_json|json_script:"block-data" }}

            <!-- Schedule grid -->
            <div
                class="grid grid-cols-[100px_repeat(7,1fr)] p-4"
                style="min-width: 0; position: relative"
            >
                <!-- Time column -->
                <div
                    class="border-r border-gray-400"
                    style="position: relative"
                >
                    <div class="h-12 border-b border-gray-400"></div>
                    {% for slot in time_slots %}
                    <div
                        class="time-slot flex items-center px-2 text-sm border-b border-gray-300"
                        style="height: 40px"
                    >
                        {{ slot.0 }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Day columns -->
                {% for day in days %}
                <div
                    class="relative border-r border-gray-400"
                    style="position: relative"
                >
                    <div
                        class="h-12 text-center font-semibold border-b border-gray-400 flex items-center justify-center"
                    >
                        {{ day.date|date:"D, d M" }}
                    </div>

                    <!-- Time slot grid background -->
                    {% for slot in time_slots %}
                    <div
                        class="time-slot border-b border-gray-300"
                        style="height: 40px"
                    ></div>
                    {% endfor %}

                    <!-- Work blocks -->
                    {% for block_data in day.blocks %}
                    <div
                        class="work-block cursor-pointer absolute {% if block_data.block.archived %} bg-gray-300 border border-gray-500 {% else %} bg-blue-200 border border-blue-400 {% endif %} rounded px-2 py-1 text-xs overflow-hidden {% if block_data.block.archived %}hover:bg-gray-400{% else %}hover:bg-blue-300{% endif %} transition-colors"
                        style="top: {{ block_data.top }}px; height: {{ block_data.height }}px; width: {{ block_data.width }}%; left: {{ block_data.left }}%; z-index: 10;"
                        onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
                        title="Click for details"
                    >
                        <p
                            class="font-semibold {% if block_data.block.archived %}text-gray-700{% else %}text-blue-800{% endif %} break-words"
                        >
                            {{ block_data.block.name|default:"Work Block" }}
                            {% if block_data.block.archived %}
                            <span class="text-gray-500">(Archived)</span>
                            {% endif %}
                        </p>
                        {% if block_data.height > 25 %}
                        <p
                            class="{% if block_data.block.archived %}text-gray-600{% else %}text-blue-600{% endif %} break-words"
                        >
                            {{ block_data.block.localization|default:"" }}
                        </p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Information balloon -->
    <div
        id="info-balloon"
        class="absolute bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden z-50 max-w-xs"
    >
        <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-gray-800" id="balloon-title"></h3>
            <button
                onclick="hideBlockInfo()"
                class="text-gray-400 hover:text-gray-600 ml-2"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>
        <div id="balloon-content" class="text-sm text-gray-600 space-y-1">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Employee Assignment Modal -->
    <div
        id="employee-assignment-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
    >
        <div
            class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    Assign Employees
                </h2>
                <button
                    onclick="closeEmployeeModal()"
                    class="text-gray-400 hover:text-gray-600"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        ></path>
                    </svg>
                </button>
            </div>

            <div class="mb-4">
                <h3
                    id="modal-work-block-title"
                    class="text-lg font-semibold text-gray-700"
                ></h3>
                <p
                    id="modal-work-block-details"
                    class="text-sm text-gray-600"
                ></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Available Employees -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4
                        class="font-semibold text-gray-700 mb-3 flex items-center"
                    >
                        <svg
                            class="w-5 h-5 mr-2 text-blue-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                            ></path>
                        </svg>
                        Available Employees
                    </h4>
                    <div
                        id="available-employees"
                        class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                    >
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Assigned Employees -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h4
                        class="font-semibold text-gray-700 mb-3 flex items-center"
                    >
                        <svg
                            class="w-5 h-5 mr-2 text-green-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                        Assigned Employees
                    </h4>
                    <div
                        id="assigned-employees"
                        class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                    >
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button
                    onclick="closeEmployeeModal()"
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                >
                    Cancel
                </button>
                <button
                    onclick="saveEmployeeAssignments()"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                >
                    Save Assignments
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Work Block Modal -->
    <div
        id="edit-work-block-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
    >
        <div
            class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Edit Work Block</h2>
                <button
                    onclick="closeEditModal()"
                    class="text-gray-400 hover:text-gray-600"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        ></path>
                    </svg>
                </button>
            </div>

            <form id="edit-work-block-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Name</label
                        >
                        <input
                            type="text"
                            id="edit-name"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Location</label
                        >
                        <input
                            type="text"
                            id="edit-localization"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Client</label
                        >
                        <select
                            id="edit-client"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Select Client</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Duration (hours)</label
                        >
                        <input
                            type="number"
                            step="0.25"
                            id="edit-duration"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Start Time</label
                        >
                        <input
                            type="time"
                            id="edit-start-time"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >End Time</label
                        >
                        <input
                            type="time"
                            id="edit-end-time"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Hourly Value (€)</label
                        >
                        <input
                            type="number"
                            step="0.01"
                            id="edit-hourly-value"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">
                        Employee Assignments
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Available Employees for Edit -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4
                                class="font-semibold text-gray-700 mb-3 flex items-center"
                            >
                                <svg
                                    class="w-5 h-5 mr-2 text-blue-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                                    ></path>
                                </svg>
                                Available Employees
                            </h4>
                            <div
                                id="edit-available-employees"
                                class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                            >
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Assigned Employees for Edit -->
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4
                                class="font-semibold text-gray-700 mb-3 flex items-center"
                            >
                                <svg
                                    class="w-5 h-5 mr-2 text-green-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                                Assigned Employees
                            </h4>
                            <div
                                id="edit-assigned-employees"
                                class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                            >
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button
                        type="button"
                        onclick="closeEditModal()"
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="button"
                        onclick="saveWorkBlockEdit()"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
                    >
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        var blockData = {};
        var currentBalloon = null;

        // Load block data when page loads or when HTMX updates content
        function loadBlockData() {
            try {
                const blockDataElement = document.getElementById("block-data");
                if (blockDataElement) {
                    blockData = JSON.parse(blockDataElement.textContent);
                    console.log("Block data loaded:", blockData);
                }
            } catch (e) {
                console.error("Error parsing block data:", e);
                blockData = {};
            }
        }

        // Update navigation buttons
        function updateNavigation() {
            // Get current navigation data from the DOM
            const currentTitle =
                document.getElementById("schedule-title").textContent;
            console.log("Current title:", currentTitle);

            // Log navigation button states
            const navButtons = document.querySelectorAll("#nav-bar a");
            console.log("Navigation buttons found:", navButtons.length);
            if (navButtons.length >= 3) {
                console.log("Previous button href:", navButtons[0].href);
                console.log("Next button href:", navButtons[2].href);
            }
        }

        // Load on initial page load
        document.addEventListener("DOMContentLoaded", loadBlockData);

        // Load after HTMX updates content
        document.addEventListener("htmx:afterSwap", function () {
            loadBlockData();
            // Add a small delay to ensure the navigation buttons are properly updated
            setTimeout(function () {
                console.log(
                    "DEBUG: HTMX swap completed, navigation should be updated",
                );
            }, 150);
        });

        function showBlockInfo(blockId, element, event) {
            event.stopPropagation();

            console.log("Showing info for block:", blockId);

            const balloon = document.getElementById("info-balloon");
            const title = document.getElementById("balloon-title");
            const content = document.getElementById("balloon-content");

            const block = blockData[blockId];
            if (!block) {
                console.error("Block not found:", blockId);
                return;
            }

            // Populate balloon content
            title.textContent = block.name || "Work Block";

            const employeesAssigned =
                block.employees_assigned.length > 0
                    ? block.employees_assigned.join(", ")
                    : "Empty";
            const employeesConcluded =
                block.employees_concluded.length > 0
                    ? block.employees_concluded.join(", ")
                    : "Empty";

            content.innerHTML = `
                <div><strong>Time:</strong> ${block.start_time} - ${block.end_time}</div>
                <div><strong>Duration:</strong> ${block.duration}</div>
                <div><strong>Hourly Value:</strong> €${block.hourly_value}/h</div>
                <div><strong>Location:</strong> ${block.localization}</div>
                <div><strong>Client:</strong> ${block.client}</div>
                <div><strong>Assigned:</strong> ${employeesAssigned}</div>
                <div><strong>Concluded:</strong> ${employeesConcluded}</div>
                <div><strong>Constant:</strong> ${block.constant ? "Yes" : "No"}</div>
                ${block.archived ? '<div class="text-red-500"><strong>Archived</strong></div>' : ""}
                <div class="mt-3 space-y-2">
                    <button onclick="openEmployeeModal('${blockId}')" class="w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium transition-colors">
                        Assign Employees
                    </button>
                    <button onclick="openEditModal('${blockId}')" class="w-full px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium transition-colors">
                        Edit Work Block
                    </button>
                    <button onclick="toggleArchiveBlock('${blockId}')" class="w-full px-3 py-2 ${block.archived ? "bg-yellow-500 hover:bg-yellow-600" : "bg-orange-500 hover:bg-orange-600"} text-white rounded text-sm font-medium transition-colors">
                        ${block.archived ? "Unarchive" : "Archive"} Block
                    </button>
                    <button onclick="deleteBlock('${blockId}')" class="w-full px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm font-medium transition-colors">
                        Delete Block
                    </button>
                </div>
            `;

            // Show balloon first to get proper dimensions
            balloon.classList.remove("hidden");

            // Position balloon next to the clicked element
            const rect = element.getBoundingClientRect();
            const balloonRect = balloon.getBoundingClientRect();
            const scrollTop =
                window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft =
                window.pageXOffset || document.documentElement.scrollLeft;

            let left = rect.right + scrollLeft + 10;
            let top = rect.top + scrollTop;

            // Adjust if balloon would go off screen
            if (left + balloonRect.width > window.innerWidth + scrollLeft) {
                left = rect.left + scrollLeft - balloonRect.width - 10;
            }
            if (top + balloonRect.height > window.innerHeight + scrollTop) {
                top = rect.bottom + scrollTop - balloonRect.height;
            }

            // Ensure balloon doesn't go off the left edge
            if (left < scrollLeft) {
                left = scrollLeft + 10;
            }

            // Ensure balloon doesn't go off the top edge
            if (top < scrollTop) {
                top = scrollTop + 10;
            }

            balloon.style.left = left + "px";
            balloon.style.top = top + "px";

            currentBalloon = balloon;
        }

        function hideBlockInfo() {
            const balloon = document.getElementById("info-balloon");
            balloon.classList.add("hidden");
            currentBalloon = null;
        }

        // Hide balloon when clicking outside
        document.addEventListener("click", function (event) {
            if (
                currentBalloon &&
                !currentBalloon.contains(event.target) &&
                !event.target.closest(".work-block")
            ) {
                hideBlockInfo();
            }
        });

        // Hide balloon when scrolling
        document.addEventListener("scroll", function () {
            if (currentBalloon) {
                hideBlockInfo();
            }
        });

        // Hide balloon when pressing Escape key
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape" && currentBalloon) {
                hideBlockInfo();
            }
        });

        // Employee Assignment Modal Functions
        let currentBlockId = null;
        let allEmployees = [];
        let currentAssignments = [];

        // Load all employees data
        function loadEmployeesData() {
            fetch("/api/employees/")
                .then((response) => response.json())
                .then((data) => {
                    allEmployees = data;
                })
                .catch((error) =>
                    console.error("Error loading employees:", error),
                );
        }

        function openEmployeeModal(blockId) {
            currentBlockId = blockId;
            const block = blockData[blockId];

            if (!block) {
                console.error("Block not found:", blockId);
                return;
            }

            // Update modal title and details
            document.getElementById("modal-work-block-title").textContent =
                block.name || "Work Block";
            document.getElementById("modal-work-block-details").textContent =
                `${block.start_time} - ${block.end_time} • ${block.localization} • ${block.client}`;

            // Load current assignments
            fetch(`/api/work-block/${blockId}/assignments/`)
                .then((response) => response.json())
                .then((data) => {
                    currentAssignments = data.assigned_employees || [];
                    updateEmployeeModalLists();
                    document
                        .getElementById("employee-assignment-modal")
                        .classList.remove("hidden");
                })
                .catch((error) => {
                    console.error("Error loading assignments:", error);
                    // Fallback to block data
                    currentAssignments = block.employees_assigned || [];
                    updateEmployeeModalLists();
                    document
                        .getElementById("employee-assignment-modal")
                        .classList.remove("hidden");
                });

            hideBlockInfo();
        }

        function updateEmployeeModalLists() {
            const availableContainer = document.getElementById(
                "available-employees",
            );
            const assignedContainer =
                document.getElementById("assigned-employees");

            availableContainer.innerHTML = "";
            assignedContainer.innerHTML = "";

            // Load all employees if not already loaded
            if (allEmployees.length === 0) {
                loadEmployeesData();
                // If still empty, get from block data as fallback
                if (allEmployees.length === 0) {
                    const allEmployeeNames = new Set();
                    Object.values(blockData).forEach((block) => {
                        block.employees_assigned.forEach((name) =>
                            allEmployeeNames.add(name),
                        );
                    });
                    allEmployees = Array.from(allEmployeeNames).map((name) => ({
                        name,
                    }));
                }
            }

            // Create employee items
            allEmployees.forEach((employee) => {
                const employeeName = employee.name;
                const isAssigned = currentAssignments.includes(employeeName);
                const employeeItem = createEmployeeItem(
                    employeeName,
                    isAssigned,
                );

                if (isAssigned) {
                    assignedContainer.appendChild(employeeItem);
                } else {
                    availableContainer.appendChild(employeeItem);
                }
            });

            // Add empty state messages
            if (availableContainer.children.length === 0) {
                availableContainer.innerHTML =
                    '<div class="text-gray-500 text-center py-8">All employees are assigned</div>';
            }
            if (assignedContainer.children.length === 0) {
                assignedContainer.innerHTML =
                    '<div class="text-gray-500 text-center py-8">No employees assigned</div>';
            }
        }

        function createEmployeeItem(employeeName, isAssigned) {
            const div = document.createElement("div");
            div.className = `employee-item p-3 bg-white rounded-lg shadow-sm border cursor-pointer hover:shadow-md transition-all ${isAssigned ? "border-green-200" : "border-gray-200"}`;
            div.draggable = true;
            div.dataset.employeeName = employeeName;

            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-medium text-gray-700">
                            ${employeeName.charAt(0).toUpperCase()}
                        </div>
                        <span class="ml-3 font-medium text-gray-700">${employeeName}</span>
                    </div>
                    <button onclick="toggleEmployeeAssignment('${employeeName}')" class="text-sm px-2 py-1 rounded ${isAssigned ? "bg-red-100 text-red-600 hover:bg-red-200" : "bg-green-100 text-green-600 hover:bg-green-200"} transition-colors">
                        ${isAssigned ? "Remove" : "Assign"}
                    </button>
                </div>
            `;

            // Add drag and drop functionality
            div.addEventListener("dragstart", (e) => {
                e.dataTransfer.setData("text/plain", employeeName);
                div.classList.add("opacity-50");
            });

            div.addEventListener("dragend", () => {
                div.classList.remove("opacity-50");
            });

            return div;
        }

        function toggleEmployeeAssignment(employeeName) {
            const index = currentAssignments.indexOf(employeeName);
            if (index > -1) {
                currentAssignments.splice(index, 1);
            } else {
                currentAssignments.push(employeeName);
            }
            updateEmployeeModalLists();
        }

        function setupDropZones() {
            const availableContainer = document.getElementById(
                "available-employees",
            );
            const assignedContainer =
                document.getElementById("assigned-employees");

            [availableContainer, assignedContainer].forEach((container) => {
                container.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    container.classList.add("bg-blue-50", "border-blue-300");
                });

                container.addEventListener("dragleave", () => {
                    container.classList.remove("bg-blue-50", "border-blue-300");
                });

                container.addEventListener("drop", (e) => {
                    e.preventDefault();
                    container.classList.remove("bg-blue-50", "border-blue-300");

                    const employeeName = e.dataTransfer.getData("text/plain");
                    const isAssignedContainer =
                        container.id === "assigned-employees";

                    if (
                        isAssignedContainer &&
                        !currentAssignments.includes(employeeName)
                    ) {
                        currentAssignments.push(employeeName);
                        updateEmployeeModalLists();
                    } else if (
                        !isAssignedContainer &&
                        currentAssignments.includes(employeeName)
                    ) {
                        const index = currentAssignments.indexOf(employeeName);
                        currentAssignments.splice(index, 1);
                        updateEmployeeModalLists();
                    }
                });
            });
        }

        function closeEmployeeModal() {
            document
                .getElementById("employee-assignment-modal")
                .classList.add("hidden");
            currentBlockId = null;
            currentAssignments = [];
        }

        function saveEmployeeAssignments() {
            if (!currentBlockId) return;

            const data = {
                block_id: currentBlockId,
                employee_names: currentAssignments,
            };

            fetch("/api/work-block/assign-employees/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Update the block data
                        blockData[currentBlockId].employees_assigned =
                            currentAssignments;
                        closeEmployeeModal();

                        // Refresh the page to show updated assignments
                        location.reload();
                    } else {
                        alert(
                            "Error: " +
                                (data.error || "Failed to save assignments"),
                        );
                    }
                })
                .catch((error) => {
                    console.error("Error saving assignments:", error);
                    alert("An error occurred while saving assignments");
                });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(
                            cookie.substring(name.length + 1),
                        );
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize drag and drop when modal opens
        document
            .getElementById("employee-assignment-modal")
            .addEventListener("transitionend", () => {
                if (
                    !document
                        .getElementById("employee-assignment-modal")
                        .classList.contains("hidden")
                ) {
                    setupDropZones();
                }
            });

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", () => {
            setupDropZones();
            loadEmployeesData();
        });

        // New functions for work block management
        let currentEditBlockId = null;
        let editBlockData = null;
        let editAllEmployees = [];
        let editCurrentAssignments = [];

        function deleteBlock(blockId) {
            if (
                !confirm(
                    "Are you sure you want to delete this work block? This action cannot be undone.",
                )
            ) {
                return;
            }

            fetch(`/api/work-block/${blockId}/delete/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        hideBlockInfo();
                        // Reload the schedule
                        location.reload();
                    } else {
                        alert("Error deleting work block: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error deleting work block");
                });
        }

        function toggleArchiveBlock(blockId) {
            const block = blockData[blockId];
            const action = block.archived ? "unarchive" : "archive";

            if (
                !confirm(`Are you sure you want to ${action} this work block?`)
            ) {
                return;
            }

            fetch(`/api/work-block/${blockId}/toggle-archive/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        hideBlockInfo();
                        // Reload the schedule
                        location.reload();
                    } else {
                        alert("Error archiving work block: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error archiving work block");
                });
        }

        function openEditModal(blockId) {
            currentEditBlockId = blockId;

            // Load work block details
            fetch(`/api/work-block/${blockId}/details/`)
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        editBlockData = data.work_block;

                        // Populate form fields
                        document.getElementById("edit-name").value =
                            editBlockData.name;
                        document.getElementById("edit-localization").value =
                            editBlockData.localization;
                        document.getElementById("edit-start-time").value =
                            editBlockData.start_time;
                        document.getElementById("edit-end-time").value =
                            editBlockData.end_time;
                        document.getElementById("edit-duration").value =
                            editBlockData.duration;
                        document.getElementById("edit-hourly-value").value =
                            editBlockData.hourly_value;

                        // Populate client dropdown
                        const clientSelect =
                            document.getElementById("edit-client");
                        clientSelect.innerHTML =
                            '<option value="">Select Client</option>';
                        data.clients.forEach((client) => {
                            const option = document.createElement("option");
                            option.value = client;
                            option.textContent = client;
                            if (client === editBlockData.client) {
                                option.selected = true;
                            }
                            clientSelect.appendChild(option);
                        });

                        // Set up employee assignments
                        editCurrentAssignments = editBlockData.employees.map(
                            (emp) => ({
                                name: emp.name,
                                duration: emp.duration,
                                is_completed: emp.is_completed,
                            }),
                        );

                        updateEditEmployeeModalLists();
                        document
                            .getElementById("edit-work-block-modal")
                            .classList.remove("hidden");
                    } else {
                        alert(
                            "Error loading work block details: " + data.error,
                        );
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error loading work block details");
                });

            hideBlockInfo();
        }

        function closeEditModal() {
            document
                .getElementById("edit-work-block-modal")
                .classList.add("hidden");
            currentEditBlockId = null;
            editBlockData = null;
            editCurrentAssignments = [];
        }

        function updateEditEmployeeModalLists() {
            const availableContainer = document.getElementById(
                "edit-available-employees",
            );
            const assignedContainer = document.getElementById(
                "edit-assigned-employees",
            );

            // Clear containers
            availableContainer.innerHTML = "";
            assignedContainer.innerHTML = "";

            // Get assigned employee names
            const assignedNames = editCurrentAssignments.map((emp) => emp.name);

            // Add available employees
            allEmployees.forEach((employee) => {
                if (!assignedNames.includes(employee.name)) {
                    const item = createEditEmployeeItem(employee.name, false);
                    availableContainer.appendChild(item);
                }
            });

            // Add assigned employees
            editCurrentAssignments.forEach((assignment) => {
                const item = createEditEmployeeItem(
                    assignment.name,
                    true,
                    assignment,
                );
                assignedContainer.appendChild(item);
            });
        }

        function createEditEmployeeItem(
            employeeName,
            isAssigned,
            assignment = null,
        ) {
            const div = document.createElement("div");
            div.className = `p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors`;

            if (isAssigned && assignment) {
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-800">${employeeName}</span>
                        <button onclick="toggleEditEmployeeAssignment('${employeeName}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="mt-2 space-y-2">
                        <div>
                            <label class="block text-xs text-gray-500">Duration (hours)</label>
                            <input type="number" step="0.25" value="${assignment.duration}"
                                   onchange="updateEditEmployeeDuration('${employeeName}', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" ${assignment.is_completed ? "checked" : ""}
                                   onchange="updateEditEmployeeCompletion('${employeeName}', this.checked)"
                                   class="mr-2">
                            <label class="text-xs text-gray-500">Completed</label>
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-800">${employeeName}</span>
                        <button onclick="toggleEditEmployeeAssignment('${employeeName}')" class="text-green-500 hover:text-green-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }

            return div;
        }

        function toggleEditEmployeeAssignment(employeeName) {
            const assignedIndex = editCurrentAssignments.findIndex(
                (emp) => emp.name === employeeName,
            );

            if (assignedIndex > -1) {
                // Remove from assigned
                editCurrentAssignments.splice(assignedIndex, 1);
            } else {
                // Add to assigned
                editCurrentAssignments.push({
                    name: employeeName,
                    duration: editBlockData.duration,
                    is_completed: false,
                });
            }

            updateEditEmployeeModalLists();
        }

        function updateEditEmployeeDuration(employeeName, duration) {
            const assignment = editCurrentAssignments.find(
                (emp) => emp.name === employeeName,
            );
            if (assignment) {
                assignment.duration = parseFloat(duration);
            }
        }

        function updateEditEmployeeCompletion(employeeName, isCompleted) {
            const assignment = editCurrentAssignments.find(
                (emp) => emp.name === employeeName,
            );
            if (assignment) {
                assignment.is_completed = isCompleted;
            }
        }

        function saveWorkBlockEdit() {
            if (!currentEditBlockId) return;

            const formData = {
                name: document.getElementById("edit-name").value,
                localization:
                    document.getElementById("edit-localization").value,
                client: document.getElementById("edit-client").value,
                start_time: document.getElementById("edit-start-time").value,
                end_time: document.getElementById("edit-end-time").value,
                duration: parseFloat(
                    document.getElementById("edit-duration").value,
                ),
                hourly_value: parseFloat(
                    document.getElementById("edit-hourly-value").value,
                ),
                employees: editCurrentAssignments,
            };

            fetch(`/api/work-block/${currentEditBlockId}/edit/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        closeEditModal();
                        // Reload the schedule
                        location.reload();
                    } else {
                        alert("Error updating work block: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error updating work block");
                });
        }
    </script>
</div>
{% endblock %}
