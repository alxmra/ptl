{% load l10n %}

<!-- Navigation bar - included in HTMX updates -->
<div class="mb-4 p-2 sm:p-4 border-b" id="nav-bar">
    <h1
        class="text-lg sm:text-1xl font-bold mb-2 sm:mb-0"
        id="schedule-title"
    >
    Olá {{ username }}!
    </h1>
    <h1
        class="text-lg sm:text-2xl font-bold mb-2 sm:mb-0"
        id="schedule-title"
    >
        Horário: {{ week_start|date:"d F, Y" }} - {{ week_end|date:"d F, Y" }}
    </h1>

    <!-- Mobile Navigation -->
    <div class="flex flex-col sm:hidden space-y-2">
        <div class="flex justify-between space-x-1">
            {% if show_prev %}
            <a
                href="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
                hx-get="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
                hx-target="#schedule-inner"
                hx-swap="innerHTML"
                class="flex-1 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-center text-sm"
                >← Anterior</a
            >
            {% endif %}
            <a
                href="{% url 'employee_schedule' %}"
                hx-get="{% url 'employee_schedule' %}"
                hx-target="#schedule-inner"
                hx-swap="innerHTML"
                class="flex-1 px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-center text-sm"
                >Atual</a
            >
            <a
                href="{% url 'employee_schedule_week' next_week.year next_week.week %}"
                hx-get="{% url 'employee_schedule_week' next_week.year next_week.week %}"
                hx-target="#schedule-inner"
                hx-swap="innerHTML"
                class="flex-1 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-center text-sm"
                >Próxima →</a
            >
        </div>
        <div class="flex justify-center">
            <a
                href="{% url 'logout' %}"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                >Logout</a
            >
        </div>
    </div>

    <!-- Desktop Navigation -->
    <div class="hidden sm:flex items-center justify-end space-x-2 mt-2">
        {% if show_prev %}
        <a
            href="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
            hx-get="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
            hx-target="#schedule-inner"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >Previous Week</a
        >
        {% endif %}
        <a
            href="{% url 'employee_schedule' %}"
            hx-get="{% url 'employee_schedule' %}"
            hx-target="#schedule-inner"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
            >Current Week</a
        >
        <a
            href="{% url 'employee_schedule_week' next_week.year next_week.week %}"
            hx-get="{% url 'employee_schedule_week' next_week.year next_week.week %}"
            hx-target="#schedule-inner"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >Next Week</a
        >
        <a
            href="{% url 'logout' %}"
            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
            >Logout</a
        >
    </div>
</div>

<!-- Hidden data for JavaScript -->
{{ block_data_json|json_script:"block-data" }}

<!-- Mobile Schedule View -->
<div class="block sm:hidden p-2">
    <div class="space-y-4">
        {% for day in days %}
        <div class="border rounded-lg p-3">
            <h3 class="font-semibold text-lg mb-3 border-b pb-2">
                {{ day.date|date:"D, d M" }}
            </h3>
            <div class="space-y-2">
                {% for block_data in day.blocks %}
                <div
                    class="work-block-mobile p-3 rounded-lg border-2 cursor-pointer transition-colors {% if block_data.is_completed %}bg-green-100 border-green-300 hover:bg-green-200{% else %}bg-blue-100 border-blue-300 hover:bg-blue-200{% endif %}"
                    onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
                >
                    <div class="flex justify-between items-start mb-1">
                        <h4
                            class="font-semibold {% if block_data.is_completed %}text-green-800{% else %}text-blue-800{% endif %}"
                        >
                            {{ block_data.block.name|default:"Work Block" }}
                        </h4>
                        {% if block_data.is_completed %}
                        <span class="text-green-600 font-bold text-lg">✓</span>
                        {% endif %}
                    </div>
                    <div
                        class="text-sm {% if block_data.is_completed %}text-green-600{% else %}text-blue-600{% endif %}"
                    >
                        <div>
                            {{ block_data.block.start_time |time:"H:i" }} - {{ block_data.block.end_time |time:"H:i" }}
                        </div>
                        {% if block_data.block.localization %}
                        <div>{{ block_data.block.localization }}</div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-4">No tasks scheduled</p>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Desktop Schedule Grid -->
<div class="hidden sm:block">
    <div class="overflow-x-auto">
        <div
            class="grid grid-cols-[80px_repeat(7,minmax(120px,1fr))] min-w-max"
            style="position: relative"
        >
            <!-- Time column -->
            <div class="border-r border-gray-400 sticky left-0 bg-white z-10">
                <div class="h-12 border-b border-gray-400"></div>
                {% for slot in time_slots %}
                <div
                    class="time-slot flex items-center px-2 text-xs lg:text-sm border-b border-gray-300"
                    style="height: 40px"
                >
                    {{ slot.0 }}
                </div>
                {% endfor %}
            </div>

            <!-- Day columns -->
            {% for day in days %}
            <div
                class="relative border-r border-gray-400"
                style="position: relative"
            >
                <div
                    class="h-12 text-center font-semibold border-b border-gray-400 flex items-center justify-center text-xs lg:text-sm"
                >
                    {{ day.date|date:"D, d M" }}
                </div>

                <!-- Time slot grid background -->
                {% for slot in time_slots %}
                <div
                    class="time-slot border-b border-gray-300"
                    style="height: 40px"
                ></div>
                {% endfor %}

                <!-- Work blocks -->
                {% for block_data in day.blocks %}
                <div
                    class="work-block cursor-pointer absolute rounded px-1 lg:px-2 py-1 text-xs overflow-hidden transition-colors {% if block_data.is_completed %}bg-green-200 border border-green-400 hover:bg-green-300{% else %}bg-blue-200 border border-blue-400 hover:bg-blue-300{% endif %}"
                    style="top: {{ block_data.top|unlocalize }}px; height: {{ block_data.height|unlocalize }}px; width: {{ block_data.width|unlocalize }}%; left: {{ block_data.left|unlocalize }}%; z-index: 10; min-height: 20px; touch-action: manipulation;"
                    onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
                    title="Click for details"
                >
                    <p
                        class="font-semibold {% if block_data.is_completed %}text-green-800{% else %}text-blue-800{% endif %} break-words leading-tight"
                    >
                        {{ block_data.block.name|default:"Work Block" }}
                    </p>
                    {% if block_data.height > 25 %}
                    <p
                        class="{% if block_data.is_completed %}text-green-600{% else %}text-blue-600{% endif %} break-words leading-tight"
                    >
                        {{ block_data.block.localization|default:"" }}
                    </p>
                    {% endif %} {% if block_data.is_completed %}
                    <p class="text-green-600 font-bold">✓</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
