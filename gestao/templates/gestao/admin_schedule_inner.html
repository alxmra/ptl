{% load l10n %}
<!-- Navigation bar - included in HTMX updates -->
<div class="flex justify-between items-center mb-4 p-4 border-b" id="nav-bar">
    <div class="flex items-center space-x-3">
        <h1 class="text-xl font-bold" id="schedule-title">
            Todos os Horários: {{ week_start }} - {{ week_end }}
        </h1>
        <button
            id="exit-zoom-btn"
            onclick="exitDayZoom()"
            class="hidden px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
            title="Exit zoom mode"
        >
            Exit Zoom
        </button>
    </div>
    <div class="flex items-center space-x-2">
        <a
            href="{% url 'admin_schedule_week' prev_week.year prev_week.week %}"
            hx-get="{% url 'admin_schedule_week' prev_week.year prev_week.week %}"
            hx-target="#schedule-inner"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >Semana Anterior</a
        >
        <a
            href="{% url 'admin_schedule' %}"
            hx-get="{% url 'admin_schedule' %}"
            hx-target="#schedule-inner"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
            >Atual</a
        >
        <a
            href="{% url 'admin_schedule_week' next_week.year next_week.week %}"
            hx-get="{% url 'admin_schedule_week' next_week.year next_week.week %}"
            hx-target="#schedule-inner"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >Próxima Semana</a
        >
        <a
            href="{% url 'admin_statistics' %}"
            class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
            >Estatísticas</a
        >
        <a
            href="/admin/"
            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            >Painel</a
        >
    </div>
</div>

<!-- Hidden data for JavaScript -->
{{ block_data_json|json_script:"block-data" }}

<!-- Schedule grid with darker borders -->
<div
    id="schedule-grid"
    class="grid grid-cols-[100px_repeat(7,1fr)] p-4 transition-all duration-300 ease-in-out"
    style="min-width: 0; position: relative"
>
    <!-- Time column -->
    <div class="border-r border-gray-400" style="position: relative">
        <div class="h-12 border-b border-gray-400"></div>
        {% for slot in time_slots %}
        <div
            class="time-slot flex items-center px-2 text-sm border-b border-gray-300"
            style="height: 40px"
        >
            {{ slot.0 }}
        </div>
        {% endfor %}
    </div>

    <!-- Day columns -->
    {% for day in days %}
    <div
        class="day-column relative border-r border-gray-400 transition-all duration-300 ease-in-out"
        style="position: relative"
        data-day-index="{{ forloop.counter0 }}"
    >
        <div
            class="h-12 text-center font-semibold border-b border-gray-400 flex items-center justify-center cursor-pointer hover:bg-blue-50 transition-all duration-200 ease-in-out"
            onclick="toggleDayZoom({{ forloop.counter0 }})"
            title="Clica para ver este dia com mais detalhe"
        >
            {{ day.date|date:"l, d M." }}
        </div>

        <!-- Time slot grid background -->
        {% for slot in time_slots %}
        <div
            class="time-slot border-b border-gray-300"
            style="height: 40px"
        ></div>
        {% endfor %}

        <!-- Work blocks -->
        {% for block_data in day.blocks %}
        <div
            class="work-block cursor-pointer absolute {% if block_data.block.archived %}bg-gray-300 border border-gray-500{% else %}bg-blue-200 border border-blue-400{% endif %} bg-blue-200 border border-blue-400 rounded px-2 py-1 text-xs overflow-hidden {% if block_data.block.archived %}hover:bg-gray-400{% else %}hover:bg-blue-300{% endif %} hover:bg-blue-300 transition-all duration-300 ease-in-out"
            style="top: {{ block_data.top|unlocalize }}px; height: {{ block_data.height|unlocalize }}px; width: {{ block_data.width|unlocalize }}%; left: {{ block_data.left|unlocalize }}%; z-index: 10;"
            onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
            title="Click for details"
        >
            <p
                class="font-semibold {% if block_data.block.archived %}text-gray-700{% else %}text-blue-800{% endif %} text-blue-800 break-words"
            >
                {{ block_data.block.name|default:"Work Block" }} 
                {% if block_data.block.archived %}
                <span class="text-gray-500 italic">(Archived)</span>
                {% endif %}
            </p>
            {% if block_data.height > 25 %}
            <p class="{% if block_data.block.archived %}text-gray-600{% else %}text-blue-600{% endif %} break-words">
                {{ block_data.block.localization|default:"" }}
            </p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- Employee Assignment Modal -->
<div
    id="employee-assignment-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
>
    <div
        class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
    >
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Assign Employees</h2>
            <button
                onclick="closeEmployeeModal()"
                class="text-gray-400 hover:text-gray-600"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <div class="mb-4">
            <h3
                id="modal-work-block-title"
                class="text-lg font-semibold text-gray-700"
            ></h3>
            <p id="modal-work-block-details" class="text-sm text-gray-600"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Available Employees -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <svg
                        class="w-5 h-5 mr-2 text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                        ></path>
                    </svg>
                    Available Employees
                </h4>
                <div
                    id="available-employees"
                    class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                >
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Assigned Employees -->
            <div class="bg-green-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <svg
                        class="w-5 h-5 mr-2 text-green-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    Assigned Employees
                </h4>
                <div
                    id="assigned-employees"
                    class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto"
                >
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-end space-x-3">
            <button
                onclick="closeEmployeeModal()"
                class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
            >
                Cancel
            </button>
            <button
                onclick="saveEmployeeAssignments()"
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
            >
                Save Assignments
            </button>
        </div>
    </div>
</div>
