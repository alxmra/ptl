{% extends 'base.html' %} {% load humanize %} {% load duration_filters %} {%
block content %}

<!-- Add Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container mx-auto p-4">
    <div class="bg-white rounded shadow">
        <!-- Navigation -->
        <div class="flex justify-between items-center mb-4 p-4 border-b">
            <h1 class="text-2xl font-bold">
                Statistics: {{ month_name }} {{ year }}
            </h1>
            <div class="flex items-center space-x-2">
                <a
                    href="{% url 'admin_statistics_month' prev_month.year prev_month.month %}"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    >Previous Month</a
                >
                <a
                    href="{% url 'admin_statistics' %}"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                    >Current Month</a
                >
                <a
                    href="{% url 'admin_statistics_month' next_month.year next_month.month %}"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    >Next Month</a
                >
                <a
                    href="{% url 'admin_schedule' %}"
                    class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
                    >Schedule</a
                >
                <a
                    href="/admin/"
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                    >Admin Dashboard</a
                >
            </div>
        </div>

        <div class="p-4">
            <!-- Employee Statistics -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Employee Statistics</h2>
                    <div class="flex space-x-2">
                        <button
                            onclick="hideAllEmployeeDetails()"
                            class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                        >
                            Hide All Details
                        </button>
                        <a
                            href="{% url 'admin_statistics_month' year month %}?export=employee_csv"
                            class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                        >
                            Export Employee Data (CSV)
                        </a>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-300">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left border-b">
                                    Employee
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Hours Worked ({{ month_name }})
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Expected Hours
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Value Earned ({{ month_name }})
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Current Week Blocks
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Current Week Hours
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Details
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in employee_stats %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 border-b font-medium">
                                    {{ stat.employee.name }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    {{ stat.total_hours_worked|duration_format
                                    }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    {{ stat.expected_hours|duration_format }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    €{{ stat.total_value_earned|floatformat:2 }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    {{ stat.current_week_blocks_assigned }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    {{
                                    stat.current_week_hours_assigned|duration_format
                                    }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    <button
                                        onclick="toggleEmployeeDetails('{{ stat.employee.id }}')"
                                        class="px-2 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                                    >
                                        Show Details
                                    </button>
                                </td>
                            </tr>
                            <tr
                                id="employee-details-{{ stat.employee.id }}"
                                class="hidden"
                            >
                                <td
                                    colspan="7"
                                    class="px-4 py-2 bg-gray-50 border-b"
                                >
                                    <div class="max-h-60 overflow-y-auto">
                                        <h4 class="font-semibold mb-2">
                                            Daily Work Details for {{
                                            stat.employee.name }}:
                                        </h4>
                                        {% for day, day_data in stat.daily_work
                                        %}
                                        <div
                                            class="mb-3 p-2 bg-white rounded border"
                                        >
                                            <h5
                                                class="font-medium text-sm mb-1"
                                            >
                                                {{ day_data.date|date:"l, F d"
                                                }} - Total: {{
                                                day_data.total_hours|duration_format
                                                }}
                                            </h5>
                                            {% for assignment in
                                            day_data.assignments %}
                                            <div class="text-xs ml-4 mb-1">
                                                <strong
                                                    >{{
                                                    assignment.work_block.name|default:"Work
                                                    Block" }}</strong
                                                >
                                                ({{
                                                assignment.work_block.client.name|default:"Outros"
                                                }}) - {{
                                                assignment.duration|duration_format
                                                }} @ €{{
                                                assignment.work_block.hourly_value|floatformat:2
                                                }}/h{% if
                                                assignment.work_block.localization
                                                %} - {{
                                                assignment.work_block.localization
                                                }}{% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% empty %}
                                        <p class="text-sm text-gray-500">
                                            No work completed this month.
                                        </p>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td
                                    colspan="7"
                                    class="px-4 py-2 text-center text-gray-500"
                                >
                                    No employee data available
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Client Statistics -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Client Statistics</h2>
                    <div class="flex space-x-2">
                        <button
                            onclick="hideAllClientDetails()"
                            class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600"
                        >
                            Hide All Details
                        </button>
                        <a
                            href="{% url 'admin_statistics_month' year month %}?export=client_csv"
                            class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                        >
                            Export Client Data (CSV)
                        </a>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-300">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left border-b">
                                    Client
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Hours Worked ({{ month_name }})
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Total Value
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Workers Count
                                </th>
                                <th class="px-4 py-2 text-left border-b">
                                    Details
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in client_stats %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 border-b font-medium">
                                    {{ stat.client.name }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    {{ stat.total_hours|duration_format }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    €{{ stat.total_value|floatformat:2 }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    {{ stat.unique_workers }}
                                </td>
                                <td class="px-4 py-2 border-b">
                                    <button
                                        onclick="toggleClientDetails('{{ stat.client.id }}')"
                                        class="px-2 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                                    >
                                        Show Details
                                    </button>
                                </td>
                            </tr>
                            <tr
                                id="client-details-{{ stat.client.id }}"
                                class="hidden"
                            >
                                <td
                                    colspan="5"
                                    class="px-4 py-2 bg-gray-50 border-b"
                                >
                                    <div class="max-h-60 overflow-y-auto">
                                        <h4 class="font-semibold mb-2">
                                            Daily Work Details for {{
                                            stat.client.name }}:
                                        </h4>
                                        {% for day, day_data in stat.daily_work
                                        %}
                                        <div
                                            class="mb-3 p-2 bg-white rounded border"
                                        >
                                            <h5
                                                class="font-medium text-sm mb-1"
                                            >
                                                {{ day_data.date|date:"l, F d"
                                                }}
                                            </h5>
                                            {% for assignment in
                                            day_data.assignments %}
                                            <div class="text-xs ml-4 mb-1">
                                                <strong
                                                    >{{ assignment.employee.name
                                                    }}</strong
                                                >: {{
                                                assignment.work_block.name|default:"Work
                                                Block" }} ({{
                                                assignment.work_block.start_time|time:"H:i"
                                                }}-{{
                                                assignment.work_block.end_time|time:"H:i"
                                                }}) - {{
                                                assignment.duration|duration_format
                                                }} @ €{{
                                                assignment.work_block.hourly_value|floatformat:2
                                                }}/h{% if
                                                assignment.work_block.localization
                                                %} - {{
                                                assignment.work_block.localization
                                                }}{% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% empty %}
                                        <p class="text-sm text-gray-500">
                                            No work completed this month.
                                        </p>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td
                                    colspan="5"
                                    class="px-4 py-2 text-center text-gray-500"
                                >
                                    No client data available
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">
                    Daily Work Hours Charts
                </h2>

                <!-- Employee Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">
                            Employee Daily Hours
                        </h3>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium">Show:</label>
                            <button
                                onclick="selectAllEmployees()"
                                class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                            >
                                All
                            </button>
                            <button
                                onclick="deselectAllEmployees()"
                                class="px-2 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600"
                            >
                                None
                            </button>
                        </div>
                    </div>

                    <!-- Employee Selection -->
                    <div
                        class="mb-4 max-h-32 overflow-y-auto border rounded p-2"
                    >
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {% for stat in employee_stats %}
                            <label class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    class="employee-checkbox"
                                    value="{{ stat.employee.id }}"
                                    checked
                                />
                                <span class="text-sm"
                                    >{{ stat.employee.name }}</span
                                >
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="relative h-96">
                        <canvas id="employeeChart"></canvas>
                    </div>
                </div>

                <!-- Client Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">
                            Client Daily Hours
                        </h3>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium">Show:</label>
                            <button
                                onclick="selectAllClients()"
                                class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                            >
                                All
                            </button>
                            <button
                                onclick="deselectAllClients()"
                                class="px-2 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600"
                            >
                                None
                            </button>
                        </div>
                    </div>

                    <!-- Client Selection -->
                    <div
                        class="mb-4 max-h-32 overflow-y-auto border rounded p-2"
                    >
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {% for stat in client_stats %}
                            <label class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    class="client-checkbox"
                                    value="{{ stat.client.id }}"
                                    checked
                                />
                                <span class="text-sm"
                                    >{{ stat.client.name }}</span
                                >
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="relative h-96">
                        <canvas id="clientChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Monthly Summary</h2>
                    <a
                        href="{% url 'admin_statistics_month' year month %}?export=combined_csv"
                        class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                    >
                        Export Combined Data (CSV)
                    </a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-100 p-4 rounded">
                        <h3 class="font-semibold text-blue-800">
                            Total Employees
                        </h3>
                        <p class="text-2xl font-bold text-blue-600">
                            {{ employee_stats|length }}
                        </p>
                    </div>
                    <div class="bg-green-100 p-4 rounded">
                        <h3 class="font-semibold text-green-800">
                            Total Clients
                        </h3>
                        <p class="text-2xl font-bold text-green-600">
                            {{ client_stats|length }}
                        </p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded">
                        <h3 class="font-semibold text-purple-800">
                            Current Month
                        </h3>
                        <p class="text-2xl font-bold text-purple-600">
                            {{ month_name }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Chart data - populated by Django
    const employeeChartData = {{ employee_chart_data|safe }};
    const clientChartData = {{ client_chart_data|safe }};

    // Get days in current month
    const daysInMonth = new Date({{ year }}, {{ month }}, 0).getDate();
    const monthDays = Array.from({length: daysInMonth}, (_, i) => i + 1);

    // Chart configurations
    let employeeChart, clientChart;

    // Color palette
    const colors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
        '#06b6d4', '#f97316', '#84cc16', '#ec4899', '#6b7280',
        '#14b8a6', '#f43f5e', '#8b5cf6', '#06b6d4', '#f97316'
    ];

    function initializeCharts() {
        // Employee Chart
        const employeeCtx = document.getElementById('employeeChart').getContext('2d');
        employeeChart = new Chart(employeeCtx, {
            type: 'line',
            data: {
                labels: monthDays,
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Hours Worked by Employee'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Day of Month'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Hours Worked'
                        },
                        beginAtZero: true
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // Client Chart
        const clientCtx = document.getElementById('clientChart').getContext('2d');
        clientChart = new Chart(clientCtx, {
            type: 'line',
            data: {
                labels: monthDays,
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Daily Hours Worked by Client'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Day of Month'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Hours Worked'
                        },
                        beginAtZero: true
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // Update charts with initial data
        updateEmployeeChart();
        updateClientChart();
    }

    function updateEmployeeChart() {
        const checkedEmployees = Array.from(document.querySelectorAll('.employee-checkbox:checked'))
            .map(cb => cb.value);

        const datasets = checkedEmployees.map((employeeId, index) => {
            const employee = employeeChartData.find(emp => emp.id == employeeId);
            if (!employee) return null;

            const data = monthDays.map(day => employee.daily_hours[day] || 0);

            return {
                label: employee.name,
                data: data,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                borderWidth: 2,
                tension: 0.1,
                fill: false
            };
        }).filter(dataset => dataset !== null);

        employeeChart.data.datasets = datasets;
        employeeChart.update();
    }

    function updateClientChart() {
        const checkedClients = Array.from(document.querySelectorAll('.client-checkbox:checked'))
            .map(cb => cb.value);

        const datasets = checkedClients.map((clientId, index) => {
            // Find the client data
            const clientData = clientChartData.find(client => client.id == clientId);
            if (!clientData) return null;

            // Calculate total hours per day for this client
            const data = monthDays.map(day => {
                return clientData.daily_hours[day] || 0;
            });

            return {
                label: clientData.name,
                data: data,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                borderWidth: 2,
                tension: 0.1,
                fill: false
            };
        }).filter(dataset => dataset !== null);

        clientChart.data.datasets = datasets;
        clientChart.update();
    }

    // Selection functions
    function selectAllEmployees() {
        document.querySelectorAll('.employee-checkbox').forEach(cb => {
            cb.checked = true;
        });
        updateEmployeeChart();
    }

    function deselectAllEmployees() {
        document.querySelectorAll('.employee-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateEmployeeChart();
    }

    function selectAllClients() {
        document.querySelectorAll('.client-checkbox').forEach(cb => {
            cb.checked = true;
        });
        updateClientChart();
    }

    function deselectAllClients() {
        document.querySelectorAll('.client-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateClientChart();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();

        // Add event listeners for checkboxes
        document.querySelectorAll('.employee-checkbox').forEach(cb => {
            cb.addEventListener('change', updateEmployeeChart);
        });

        document.querySelectorAll('.client-checkbox').forEach(cb => {
            cb.addEventListener('change', updateClientChart);
        });
    });

    function toggleClientDetails(clientId) {
        const detailsRow = document.getElementById('client-details-' + clientId);
        const button = event.target;

        if (detailsRow.classList.contains('hidden')) {
            detailsRow.classList.remove('hidden');
            button.textContent = 'Hide Details';
            button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            button.classList.add('bg-red-500', 'hover:bg-red-600');
        } else {
            detailsRow.classList.add('hidden');
            button.textContent = 'Show Details';
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            button.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
    }

    function toggleEmployeeDetails(employeeId) {
        const detailsRow = document.getElementById('employee-details-' + employeeId);
        const button = event.target;

        if (detailsRow.classList.contains('hidden')) {
            detailsRow.classList.remove('hidden');
            button.textContent = 'Hide Details';
            button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            button.classList.add('bg-red-500', 'hover:bg-red-600');
        } else {
            detailsRow.classList.add('hidden');
            button.textContent = 'Show Details';
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            button.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
    }

    function hideAllEmployeeDetails() {
        const employeeDetailsRows = document.querySelectorAll('[id^="employee-details-"]');
        const employeeButtons = document.querySelectorAll('button[onclick*="toggleEmployeeDetails"]');

        employeeDetailsRows.forEach(row => {
            row.classList.add('hidden');
        });

        employeeButtons.forEach(button => {
            button.textContent = 'Show Details';
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            button.classList.add('bg-blue-500', 'hover:bg-blue-600');
        });
    }

    function hideAllClientDetails() {
        const clientDetailsRows = document.querySelectorAll('[id^="client-details-"]');
        const clientButtons = document.querySelectorAll('button[onclick*="toggleClientDetails"]');

        clientDetailsRows.forEach(row => {
            row.classList.add('hidden');
        });

        clientButtons.forEach(button => {
            button.textContent = 'Show Details';
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            button.classList.add('bg-blue-500', 'hover:bg-blue-600');
        });
    }
</script>

{% endblock %}
