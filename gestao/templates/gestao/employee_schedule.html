{% extends 'base.html' %} {% load humanize %} {% load l10n %} {% block content %}
<div class="container mx-auto p-2 sm:p-4">
    <!-- htmx target for schedule content -->
    <div id="schedule-content" class="bg-white rounded shadow">
        <div id="schedule-inner">
            <!-- Navigation moved inside the HTMX target for proper updating -->
            <div class="mb-4 p-2 sm:p-4 border-b" id="nav-bar">
                <h1
                    class="text-lg sm:text-1xl font-bold mb-2 sm:mb-0"
                    id="schedule-title"
                >
                Olá {{ username }}!
                </h1>
                <h1
                    class="text-lg sm:text-2xl font-bold mb-2 sm:mb-0"
                    id="schedule-title"
                >
                    Horário: {{ week_start|date:"d F, Y" }} - {{ week_end|date:"d F, Y" }}
                </h1>

                <!-- Mobile Navigation -->
                <div class="flex flex-col sm:hidden space-y-2">
                    <div class="flex justify-between space-x-1">
                        {% if show_prev %}
                        <a
                            href="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
                            hx-get="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
                            hx-target="#schedule-inner"
                            hx-swap="innerHTML"
                            class="flex-1 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-center text-sm"
                            >← Anterior</a
                        >
                        {% endif %}
                        <a
                            href="{% url 'employee_schedule' %}"
                            hx-get="{% url 'employee_schedule' %}"
                            hx-target="#schedule-inner"
                            hx-swap="innerHTML"
                            class="flex-1 px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-center text-sm"
                            >Atual</a
                        >
                        <a
                            href="{% url 'employee_schedule_week' next_week.year next_week.week %}"
                            hx-get="{% url 'employee_schedule_week' next_week.year next_week.week %}"
                            hx-target="#schedule-inner"
                            hx-swap="innerHTML"
                            class="flex-1 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-center text-sm"
                            >Próxima →</a
                        >
                    </div>
                    <div class="flex justify-center">
                        <a
                            href="{% url 'logout' %}"
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                            >Terminar Sessão</a
                        >
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <div
                    class="hidden sm:flex items-center justify-end space-x-2 mt-2"
                >
                    {% if show_prev %}
                    <a
                        href="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
                        hx-get="{% url 'employee_schedule_week' prev_week.year prev_week.week %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >Semana Anterior</a
                    >
                    {% endif %}
                    <a
                        href="{% url 'employee_schedule' %}"
                        hx-get="{% url 'employee_schedule' %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                        >Semana Atual</a
                    >
                    <a
                        href="{% url 'employee_schedule_week' next_week.year next_week.week %}"
                        hx-get="{% url 'employee_schedule_week' next_week.year next_week.week %}"
                        hx-target="#schedule-inner"
                        hx-swap="innerHTML"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >Próxima Semana</a
                    >
                    <a
                        href="{% url 'logout' %}"
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                        >Terminar Sessão</a
                    >
                </div>
            </div>

            <!-- Hidden data for JavaScript -->
            {{ block_data_json|json_script:"block-data" }}

            <!-- Mobile Schedule View -->
            <div class="block sm:hidden p-2">
                <div class="space-y-4">
                    {% for day in days %}
                    <div class="border rounded-lg p-3">
                        <h3 class="font-semibold text-lg mb-3 border-b pb-2">
                            {{ day.date|date:"D, d M" }}
                        </h3>
                        <div class="space-y-2">
                            {% for block_data in day.blocks %}
                            <div
                                class="work-block-mobile p-3 rounded-lg border-2 cursor-pointer transition-colors {% if block_data.is_completed %}bg-green-100 border-green-300 hover:bg-green-200{% else %}bg-blue-100 border-blue-300 hover:bg-blue-200{% endif %}"
                                onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
                            >
                                <div
                                    class="flex justify-between items-start mb-1"
                                >
                                    <h4
                                        class="font-semibold {% if block_data.is_completed %}text-green-800{% else %}text-blue-800{% endif %}"
                                    >
                                        {{ block_data.block.name|default:"Work Block" }}
                                    </h4>
                                    {% if block_data.is_completed %}
                                    <span
                                        class="text-green-600 font-bold text-lg"
                                        >✓</span
                                    >
                                    {% endif %}
                                </div>
                                <div
                                    class="text-sm {% if block_data.is_completed %}text-green-600{% else %}text-blue-600{% endif %}"
                                >
                                    <div>
                                        {{ block_data.block.start_time |time:"H:i" }} - {{ block_data.block.end_time |time:"H:i" }}
                                    </div>
                                    {% if block_data.block.localization %}
                                    <div>
                                        {{ block_data.block.localization }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-gray-500 text-center py-4">
                                No tasks scheduled
                            </p>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Desktop Schedule Grid -->
            <div class="hidden sm:block">
                <div class="overflow-x-auto">
                    <div
                        class="grid grid-cols-[80px_repeat(7,minmax(120px,1fr))] min-w-max"
                        style="position: relative"
                    >
                        <!-- Time column -->
                        <div
                            class="border-r border-gray-400 sticky left-0 bg-white z-10"
                        >
                            <div class="h-12 border-b border-gray-400"></div>
                            {% for slot in time_slots %}
                            <div
                                class="time-slot flex items-center px-2 text-xs lg:text-sm border-b border-gray-300"
                                style="height: 40px"
                            >
                                {{ slot.0 }}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Day columns -->
                        {% for day in days %}
                        <div
                            class="relative border-r border-gray-400"
                            style="position: relative"
                        >
                            <div
                                class="h-12 text-center font-semibold border-b border-gray-400 flex items-center justify-center text-xs lg:text-sm"
                            >
                                {{ day.date|date:"D, d M" }}
                            </div>

                            <!-- Time slot grid background -->
                            {% for slot in time_slots %}
                            <div
                                class="time-slot border-b border-gray-300"
                                style="height: 40px"
                            ></div>
                            {% endfor %}

                            <!-- Work blocks -->
                            {% for block_data in day.blocks %}
                            <div
                                class="work-block cursor-pointer absolute rounded px-1 lg:px-2 py-1 text-xs overflow-hidden transition-colors {% if block_data.is_completed %}bg-green-200 border border-green-400 hover:bg-green-300{% else %}bg-blue-200 border border-blue-400 hover:bg-blue-300{% endif %}"
                                style="top: {{ block_data.top|unlocalize }}px; height: {{ block_data.height|unlocalize }}px; width: {{ block_data.width|unlocalize }}%; left: {{ block_data.left|unlocalize }}%; z-index: 10; min-height: 20px; touch-action: manipulation;"
                                onclick="showBlockInfo('{{ block_data.block.id }}', this, event)"
                                title="Click for details"
                            >
                                <p
                                    class="font-semibold {% if block_data.is_completed %}text-green-800{% else %}text-blue-800{% endif %} break-words leading-tight"
                                >
                                    {{ block_data.block.name|default:"Work Block" }}
                                </p>
                                {% if block_data.height > 25 %}
                                <p
                                    class="{% if block_data.is_completed %}text-green-600{% else %}text-blue-600{% endif %} break-words leading-tight"
                                >
                                    {{ block_data.block.localization|default:"" }}
                                </p>
                                {% endif %} {% if block_data.is_completed %}
                                <p class="text-green-600 font-bold">✓</p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Information balloon -->
    <div
        id="info-balloon"
        class="fixed bg-white border border-gray-300 rounded-lg shadow-xl p-4 hidden z-40 max-w-xs sm:max-w-sm mx-2"
    >
        <div class="flex justify-between items-start mb-2">
            <h3
                class="font-bold text-gray-800 text-sm sm:text-base"
                id="balloon-title"
            ></h3>
            <button
                onclick="hideBlockInfo()"
                class="text-gray-400 hover:text-gray-600 ml-2 p-1"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>
        <div
            id="balloon-content"
            class="text-xs sm:text-sm text-gray-600 space-y-1"
        >
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Duration edit modal -->
    <div
        id="duration-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"
    >
        <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full">
            <h3 class="text-lg font-bold mb-4" id="duration-title">Editar Duração</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2"
                    >Duração (HH:MM):</label
                >
                <input
                    type="text"
                    id="duration-input"
                    placeholder="00:00"
                    pattern="[0-9]{1,2}:[0-9]{2}"
                    maxlength="5"
                    class="w-full p-3 border rounded text-lg"
                />
            </div>
            <div
                class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-2"
            >
                <button
                    onclick="closeDurationModal()"
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                >
                    Cancelar
                </button>
                <button
                    onclick="saveDuration()"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                >
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <script>
        var blockData = {};
        var currentBalloon = null;
        var currentBlockId = null;

        // Detect if user is on mobile
        function isMobile() {
            return window.innerWidth < 640; // Tailwind's sm breakpoint
        }

        // Load block data when page loads or when HTMX updates content
        function loadBlockData() {
            try {
                const blockDataElement = document.getElementById("block-data");
                if (blockDataElement) {
                    blockData = JSON.parse(blockDataElement.textContent);
                    console.log("Block data loaded:", blockData);
                }
            } catch (e) {
                console.error("Error parsing block data:", e);
                blockData = {};
            }
        }

        // Load on initial page load
        document.addEventListener("DOMContentLoaded", loadBlockData);

        // Load after HTMX updates content
        document.addEventListener("htmx:afterSwap", function () {
            loadBlockData();
        });

        function showBlockInfo(blockId, element, event) {
            event.stopPropagation();

            console.log("Showing info for block:", blockId);

            const balloon = document.getElementById("info-balloon");
            const title = document.getElementById("balloon-title");
            const content = document.getElementById("balloon-content");

            const block = blockData[blockId];
            if (!block) {
                console.error("Block not found:", blockId);
                return;
            }

            // Populate balloon content
            title.textContent = block.name || "Work Block";

            const completionButton = block.can_edit
                ? `<button onclick="toggleCompletion('${blockId}')" class="w-full mt-2 px-3 py-2 ${block.is_completed ? "bg-red-500 hover:bg-red-600" : "bg-green-500 hover:bg-green-600"} text-white rounded text-sm">
                    ${block.is_completed ? "Marcar como Incompleto" : "Marcar como Completo"}
                   </button>`
                : "";

            const durationButton = block.can_edit
                ? `<button onclick="editDuration('${blockId}', ${block.duration_numeric}); hideBlockInfo()" class="w-full mt-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                    Editar Duração
                   </button>`
                : "";

            if (block.duration != block.default_duration) {
            content.innerHTML = `
                <div><strong>Horário:</strong> ${block.start_time} - ${block.end_time}</div>
                <div><strong>Duração (Pessoal):</strong> <span class="text-red-600">${block.duration}</span></div>
                <div><strong>Duração (Original):</strong> ${block.default_duration}</div>
                <div><strong>Local:</strong> ${block.localization}</div>
                <div><strong>Cliente:</strong> ${block.client}</div>
                <div><strong>Estado:</strong> ${block.is_completed ? '<span class="text-green-600">Completed</span>' : '<span class="text-red-600">Pending</span>'}</div>
                ${completionButton}
                ${durationButton}
            `;
            } else {
            content.innerHTML = `
                <div><strong>Horário:</strong> ${block.start_time} - ${block.end_time}</div>
                <div><strong>Duração (Original):</strong> ${block.default_duration}</div>
                <div><strong>Local:</strong> ${block.localization}</div>
                <div><strong>Cliente:</strong> ${block.client}</div>
                <div><strong>Estado:</strong> ${block.is_completed ? '<span class="text-green-600">Completed</span>' : '<span class="text-red-600">Pending</span>'}</div>
                ${completionButton}
                ${durationButton}
            `;
            }
            // Show balloon first to get proper dimensions
            balloon.classList.remove("hidden");

            // Position balloon
            if (isMobile()) {
                // Center balloon on mobile
                balloon.style.left = "50%";
                balloon.style.top = "50%";
                balloon.style.transform = "translate(-50%, -50%)";
            } else {
                // Position balloon next to the clicked element on desktop
                const rect = element.getBoundingClientRect();
                const balloonRect = balloon.getBoundingClientRect();
                const scrollTop =
                    window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft =
                    window.pageXOffset || document.documentElement.scrollLeft;

                let left = rect.right + scrollLeft + 10;
                let top = rect.top + scrollTop;

                // Adjust if balloon would go off screen
                if (left + balloonRect.width > window.innerWidth + scrollLeft) {
                    left = rect.left + scrollLeft - balloonRect.width - 10;
                }
                if (top + balloonRect.height > window.innerHeight + scrollTop) {
                    top = rect.bottom + scrollTop - balloonRect.height;
                }

                // Ensure balloon doesn't go off the left edge
                if (left < scrollLeft) {
                    left = scrollLeft + 10;
                }

                // Ensure balloon doesn't go off the top edge
                if (top < scrollTop) {
                    top = scrollTop + 10;
                }

                balloon.style.left = left + "px";
                balloon.style.top = top + "px";
                balloon.style.transform = "none";
            }

            currentBalloon = balloon;
        }

        function hideBlockInfo() {
            const balloon = document.getElementById("info-balloon");
            balloon.classList.add("hidden");
            currentBalloon = null;
        }

        function toggleCompletion(blockId) {
            fetch(`/toggle-completion/${blockId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/x-www-form-urlencoded",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Update the block data
                        blockData[blockId].is_completed = data.is_completed;

                        // Update mobile view
                        const mobileBlockElement = document.querySelector(
                            `.work-block-mobile[onclick="showBlockInfo('${blockId}', this, event)"]`,
                        );
                        if (mobileBlockElement) {
                            if (data.is_completed) {
                                mobileBlockElement.className =
                                    mobileBlockElement.className.replace(
                                        "bg-blue-100 border-blue-300 hover:bg-blue-200",
                                        "bg-green-100 border-green-300 hover:bg-green-200",
                                    );
                                mobileBlockElement.innerHTML =
                                    mobileBlockElement.innerHTML
                                        .replace(
                                            "text-blue-800",
                                            "text-green-800",
                                        )
                                        .replace(
                                            "text-blue-600",
                                            "text-green-600",
                                        );
                                if (
                                    !mobileBlockElement.innerHTML.includes("✓")
                                ) {
                                    const titleDiv =
                                        mobileBlockElement.querySelector(
                                            ".flex.justify-between",
                                        );
                                    if (
                                        titleDiv &&
                                        !titleDiv.innerHTML.includes("✓")
                                    ) {
                                        titleDiv.innerHTML +=
                                            '<span class="text-green-600 font-bold text-lg">✓</span>';
                                    }
                                }
                            } else {
                                mobileBlockElement.className =
                                    mobileBlockElement.className.replace(
                                        "bg-green-100 border-green-300 hover:bg-green-200",
                                        "bg-blue-100 border-blue-300 hover:bg-blue-200",
                                    );
                                mobileBlockElement.innerHTML =
                                    mobileBlockElement.innerHTML
                                        .replace(
                                            "text-green-800",
                                            "text-blue-800",
                                        )
                                        .replace(
                                            "text-green-600",
                                            "text-blue-600",
                                        );
                                const checkmark =
                                    mobileBlockElement.querySelector(
                                        ".text-green-600.font-bold.text-lg",
                                    );
                                if (checkmark) {
                                    checkmark.remove();
                                }
                            }
                        }

                        // Update desktop view
                        const blockElement = document.querySelector(
                            `.work-block[onclick="showBlockInfo('${blockId}', this, event)"]`,
                        );
                        if (blockElement) {
                            if (data.is_completed) {
                                blockElement.className =
                                    blockElement.className.replace(
                                        "bg-blue-200 border-blue-400 hover:bg-blue-300",
                                        "bg-green-200 border-green-400 hover:bg-green-300",
                                    );
                                blockElement.innerHTML = blockElement.innerHTML
                                    .replace("text-blue-800", "text-green-800")
                                    .replace("text-blue-600", "text-green-600");
                                if (!blockElement.innerHTML.includes("✓")) {
                                    blockElement.innerHTML +=
                                        '<p class="text-green-600 font-bold">✓</p>';
                                }
                            } else {
                                blockElement.className =
                                    blockElement.className.replace(
                                        "bg-green-200 border-green-400 hover:bg-green-300",
                                        "bg-blue-200 border-blue-400 hover:bg-blue-300",
                                    );
                                blockElement.innerHTML = blockElement.innerHTML
                                    .replace("text-green-800", "text-blue-800")
                                    .replace("text-green-600", "text-blue-600");
                                blockElement.innerHTML =
                                    blockElement.innerHTML.replace(
                                        '<p class="text-green-600 font-bold">✓</p>',
                                        "",
                                    );
                            }
                        }

                        hideBlockInfo();
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred while updating completion status");
                });
        }

        function editDuration(blockId, currentDuration) {
            currentBlockId = blockId;
            const durationInput = document.getElementById("duration-input");
            durationInput.value = decimalToHoursMinutes(currentDuration);

            const block = blockData[blockId];
            duratbox = document.getElementById("duration-title");
            duratbox.innerHTML = 'Editar Duração (' + block.name + ')'

            // Add input formatting for duration field
            durationInput.addEventListener("input", function (e) {
                let value = e.target.value.replace(/[^\d:]/g, "");
                if (value.length === 2 && !value.includes(":")) {
                    value += ":";
                }
                if (value.length > 5) {
                    value = value.substr(0, 5);
                }
                e.target.value = value;
            });

            document
                .getElementById("duration-modal")
                .classList.remove("hidden");
        }

        function closeDurationModal() {
            document.getElementById("duration-modal").classList.add("hidden");
            currentBlockId = null;
        }

        function saveDuration() {
            const durationInput =
                document.getElementById("duration-input").value;

            let duration;
            try {
                duration = hoursMinutesToDecimal(durationInput);
            } catch (error) {
                alert(error.message);
                return;
            }

            fetch(`/update-duration/${currentBlockId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `duration=${duration}`,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Update the block data
                        blockData[currentBlockId].duration =
                            data.duration_formatted;
                        blockData[currentBlockId].duration_numeric =
                            data.duration;
                        closeDurationModal();
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred while updating duration");
                });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(
                            cookie.substring(name.length + 1),
                        );
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Convert decimal hours to HH:MM format
        function decimalToHoursMinutes(decimal) {
            const hours = Math.floor(decimal);
            const minutes = Math.round((decimal - hours) * 60);
            return `${hours.toString().padStart(2, "0")}:${minutes
                .toString()
                .padStart(2, "0")}`;
        }

        // Convert HH:MM format to decimal hours
        function hoursMinutesToDecimal(timeString) {
            if (!timeString || !timeString.includes(":")) {
                throw new Error(
                    "Invalid time format. Please use HH:MM format.",
                );
            }
            const [hours, minutes] = timeString.split(":").map(Number);
            if (
                isNaN(hours) ||
                isNaN(minutes) ||
                minutes >= 60 ||
                minutes < 0 ||
                hours < 0
            ) {
                throw new Error(
                    "Invalid time format. Please use HH:MM format.",
                );
            }
            return hours + minutes / 60;
        }

        // Format time input as user types
        function formatTimeInput(input) {
            let value = input.value.replace(/[^\d:]/g, "");
            if (value.length === 2 && !value.includes(":")) {
                value += ":";
            }
            if (value.length > 5) {
                value = value.substr(0, 5);
            }
            input.value = value;
        }

        // Hide balloon when clicking outside
        document.addEventListener("click", function (event) {
            if (
                currentBalloon &&
                !currentBalloon.contains(event.target) &&
                !event.target.closest(".work-block") &&
                !event.target.closest(".work-block-mobile")
            ) {
                hideBlockInfo();
            }
        });

        // Hide balloon when scrolling
        document.addEventListener("scroll", function () {
            if (currentBalloon && !isMobile()) {
                hideBlockInfo();
            }
        });

        // Hide balloon when pressing Escape key
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                if (currentBalloon) {
                    hideBlockInfo();
                }
                if (
                    !document
                        .getElementById("duration-modal")
                        .classList.contains("hidden")
                ) {
                    closeDurationModal();
                }
            }
        });

        // Handle orientation change on mobile
        window.addEventListener("orientationchange", function () {
            if (currentBalloon && isMobile()) {
                // Re-center balloon after orientation change
                setTimeout(function () {
                    const balloon = document.getElementById("info-balloon");
                    balloon.style.left = "50%";
                    balloon.style.top = "50%";
                    balloon.style.transform = "translate(-50%, -50%)";
                }, 100);
            }
        });
    </script>
</div>
{% endblock %}
